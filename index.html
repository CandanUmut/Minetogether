<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>DeepMine Online ¬∑ Altƒ±n & Petrol Madenciliƒüi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #020617;
      --panel: #020617;
      --card: #020617;
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.2);
      --danger: #f97373;
      --text: #e5e7eb;
      --text-soft: #9ca3af;
      --radius: 18px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
      background: radial-gradient(circle at top, #020617, #000 55%);
      color: var(--text);
      display: flex;
      justify-content: center;
      align-items: stretch;
      min-height: 100vh;
    }

    .app {
      max-width: 1100px;
      width: 100%;
      padding: 24px 16px 32px;
    }

    .card-shell {
      position: relative;
      background: radial-gradient(circle at top, #020617, #020617 40%), var(--card);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(75, 85, 99, 0.4);
      backdrop-filter: blur(24px);
      overflow: hidden;
    }

    .card-shell > * { position: relative; z-index: 1; }

    .card-shell::after {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: var(--radius);
      background: radial-gradient(circle at 20% 20%, rgba(56, 189, 248, 0.08), transparent 35%),
                  radial-gradient(circle at 80% 0%, rgba(249, 115, 22, 0.12), transparent 30%);
      pointer-events: none;
      opacity: 0.6;
      animation: panelGlow 12s ease-in-out infinite;
      z-index: 0;
    }

    h1 {
      margin-top: 0;
      font-size: 2rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    h1 span.icon { font-size: 2.2rem; }

    .subtitle {
      color: var(--text-soft);
      margin-bottom: 12px;
      max-width: 640px;
      font-size: 0.95rem;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      margin-top: 16px;
    }

    .col {
      flex: 1 1 260px;
      min-width: 0;
    }

    .col-wide {
      flex: 1.2 1 340px;
    }

    .section-title {
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-soft);
      margin-bottom: 6px;
    }

    label {
      display: block;
      font-size: 0.8rem;
      color: var(--text-soft);
      margin-bottom: 4px;
    }

    input {
      width: 100%;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: rgba(15, 23, 42, 0.95);
      color: var(--text);
      font-size: 0.9rem;
      outline: none;
    }

    input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.4);
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 8px 16px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: linear-gradient(to right, #22c55e, #38bdf8);
      color: #0f172a;
      box-shadow: 0 8px 25px rgba(56, 189, 248, 0.45);
      transition: transform 0.1s, box-shadow 0.1s;
      white-space: nowrap;
    }

    button.secondary {
      background: transparent;
      border: 1px solid #4b5563;
      color: var(--text-soft);
      box-shadow: none;
    }

    button.small {
      padding: 6px 10px;
      font-size: 0.78rem;
    }

    button[disabled] {
      opacity: 0.5;
      cursor: default;
      box-shadow: none;
    }

    button:active {
      transform: translateY(1px) scale(0.99);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.75rem;
      border: 1px solid rgba(75, 85, 99, 0.7);
      color: var(--text-soft);
      background: rgba(15, 23, 42, 0.9);
    }

    .pill-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 8px rgba(34, 197, 94, 0.7);
    }

    .pill.offline .pill-dot {
      background: #f97373;
      box-shadow: 0 0 8px rgba(248, 113, 113, 0.7);
    }

    .error {
      color: var(--danger);
      font-size: 0.8rem;
      margin-top: 6px;
    }

    /* THREE.JS PANEL */

    .mine-panel {
      border-radius: 16px;
      border: 1px solid rgba(31, 41, 55, 0.9);
      background: radial-gradient(circle at top, #020617, #020617);
      padding: 10px;
      position: relative;
      overflow: hidden;
      box-shadow: 0 18px 36px rgba(0, 0, 0, 0.8);
      min-height: 260px;
    }

    #mine-canvas {
      width: 100%;
      height: 260px;
      display: block;
      border-radius: 14px;
      background: #020617;
    }

    .depth-hud {
      position: absolute;
      left: 12px;
      top: 12px;
      background: rgba(15, 23, 42, 0.9);
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      padding: 5px 10px;
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .depth-hud span.value {
      font-weight: 700;
      color: #facc15;
    }

    .resource-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      font-size: 0.85rem;
      margin-top: 8px;
    }

    .resource-chip {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.9);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .resource-chip span.value {
      font-weight: 700;
    }

    .controls-card {
      margin-top: 10px;
      border-radius: 14px;
      border: 1px solid rgba(31, 41, 55, 0.9);
      background: rgba(15, 23, 42, 0.96);
      padding: 10px 12px;
      font-size: 0.9rem;
      box-shadow: 0 14px 36px rgba(0, 0, 0, 0.7);
    }

    .dig-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 10px;
    }

    .dig-row button {
      font-size: 1rem;
    }

    .stat-line {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      font-size: 0.85rem;
      color: var(--text-soft);
    }

    .stat-line span.value {
      font-weight: 700;
      color: var(--text);
    }

    .upgrade-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 8px;
    }

    .upgrade-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid rgba(31, 41, 55, 0.9);
      background: rgba(15, 23, 42, 0.95);
      font-size: 0.85rem;
    }

    .upgrade-main {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .upgrade-title {
      font-weight: 600;
    }

    .upgrade-sub {
      color: var(--text-soft);
      font-size: 0.8rem;
    }

    /* LEADERBOARD + DEPTH RULER */

    .leaderboard-card {
      border-radius: 14px;
      border: 1px solid rgba(31, 41, 55, 0.9);
      background: rgba(15, 23, 42, 0.96);
      padding: 10px 12px;
      font-size: 0.85rem;
      box-shadow: 0 14px 36px rgba(0, 0, 0, 0.7);
    }

    .leaderboard-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 6px;
    }

    .leaderboard-toggle {
      display: inline-flex;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      overflow: hidden;
    }

    .leaderboard-toggle button {
      border-radius: 0;
      box-shadow: none;
      padding: 4px 10px;
      font-size: 0.75rem;
    }

    .leaderboard-toggle button.active {
      background: var(--accent);
      color: #020617;
      border-color: transparent;
    }

    .leaderboard-list {
      max-height: 260px;
      overflow-y: auto;
      padding-right: 4px;
      margin-top: 4px;
    }

    .lb-row {
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: 6px;
      padding: 4px 0;
      border-bottom: 1px dashed rgba(31, 41, 55, 0.7);
      align-items: center;
    }

    .lb-row:last-child { border-bottom: none; }

    .lb-row.me {
      background: rgba(56, 189, 248, 0.07);
      border-radius: 8px;
      padding: 4px 6px;
      border: 1px solid rgba(56, 189, 248, 0.2);
    }

    .lb-rank {
      width: 28px;
      text-align: right;
      color: var(--text-soft);
      font-weight: 600;
    }

    .lb-name {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .lb-depth {
      font-weight: 700;
      color: #facc15;
      font-variant-numeric: tabular-nums;
    }

    .me-chip {
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid rgba(56, 189, 248, 0.6);
      font-size: 0.7rem;
      color: var(--accent);
    }

    .room-code-pill {
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      font-size: 0.7rem;
      color: #e5e7eb;
      background: rgba(15, 23, 42, 0.9);
    }

    .depth-ruler {
      position: relative;
      width: 80px;
      height: 260px;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: linear-gradient(to bottom, #0f172a, #020617 40%, #111827 60%, #0b1220 100%);
      margin-top: 8px;
      overflow: hidden;
    }

    .depth-ruler-track {
      position: absolute;
      left: 50%;
      top: 0;
      bottom: 0;
      width: 2px;
      transform: translateX(-50%);
      background: linear-gradient(to bottom, #64748b, #020617);
      opacity: 0.7;
    }

    .depth-marker {
      position: absolute;
      left: 12px;
      transform: translateY(50%);
      font-size: 0.7rem;
      display: flex;
      flex-direction: column;
      gap: 1px;
    }

    .depth-marker .dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      border: 2px solid #facc15;
      background: #020617;
      box-shadow: 0 0 10px rgba(250, 204, 21, 0.7);
    }

    .depth-marker .label {
      font-size: 0.7rem;
      color: #e5e7eb;
      white-space: nowrap;
      text-shadow: 0 1px 4px rgba(0, 0, 0, 0.8);
    }

    .depth-marker.me .dot {
      border-color: #38bdf8;
      box-shadow: 0 0 10px rgba(56, 189, 248, 0.9);
    }

    .depth-marker.me .label {
      color: #38bdf8;
    }

    .small-note {
      font-size: 0.72rem;
      color: var(--text-soft);
      margin-top: 4px;
    }

    /* SETUP */

    .setup-grid {
      display: grid;
      grid-template-columns: 1.5fr 1fr;
      gap: 12px;
    }

    @media (max-width: 820px) {
      .setup-grid {
        grid-template-columns: 1fr;
      }
      .col-wide {
        flex-basis: 100%;
      }
    }

    .setup-card {
      border-radius: 14px;
      border: 1px solid rgba(31, 41, 55, 0.9);
      background: rgba(15, 23, 42, 0.96);
      padding: 12px 14px;
      font-size: 0.9rem;
      box-shadow: 0 14px 36px rgba(0, 0, 0, 0.7);
    }

    .setup-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }

    .setup-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 6px;
    }

    .code-badge {
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px dashed rgba(148, 163, 184, 0.7);
      font-size: 0.8rem;
      color: #e5e7eb;
    }

    .log {
      margin-top: 10px;
      font-size: 0.76rem;
      color: var(--text-soft);
      max-height: 110px;
      overflow-y: auto;
      border-radius: 10px;
      border: 1px solid rgba(31, 41, 55, 0.9);
      padding: 6px 8px;
      background: rgba(15, 23, 42, 0.95);
    }

    .log-line { margin-bottom: 2px; }

    @keyframes panelGlow {
      0%, 100% { opacity: 0.5; }
      50% { opacity: 0.9; }
    }
  </style>
</head>
<body>
<div class="app">
  <div class="card-shell">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
      <div>
        <h1>
          <span class="icon">‚õèÔ∏è</span>
          <span>DeepMine Online</span>
        </h1>
        <div class="subtitle">
          Tƒ±kla, kaz, altƒ±n ve petrol √ßƒ±kar. Kazmanƒ± geli≈ütir, i≈ü√ßi ve matkap al,
          sonra her ≈üeyi otomatiƒüe baƒüla. ƒ∞stersen global, istersen sadece arkada≈ülarƒ±nla aynƒ± odada yarƒ±≈ü.
        </div>
      </div>
      <div>
        <div id="online-pill" class="pill">
          <div class="pill-dot"></div>
          <span id="online-status-text">Online baƒülanmaya √ßalƒ±≈üƒ±lƒ±yor...</span>
        </div>
      </div>
    </div>

    <!-- SETUP -->
    <div id="setup-section" style="margin-top:12px;">
      <div class="setup-grid">
        <div class="setup-card">
          <div class="section-title">Oyuncu</div>
          <label for="player-name">ƒ∞smin</label>
          <input id="player-name" placeholder="Umut, Nova vs." />

          <div class="setup-row">
            <button id="btn-start-solo">
              üåç Tek ba≈üƒ±ma / Global
            </button>
          </div>

          <div class="small-note">
            ƒ∞stediƒüin zaman online/leaderboard senkronize etmeye √ßalƒ±≈üƒ±r. Baƒülantƒ± yoksa
            oyun tamamen cihazƒ±nda √ßalƒ±≈üƒ±r.
          </div>
          <div id="setup-error" class="error"></div>
        </div>

        <div class="setup-card">
          <div class="section-title">Oda (isteƒüe baƒülƒ±)</div>
          <label for="room-code-input">Mevcut bir odaya katƒ±l</label>
          <input id="room-code-input" placeholder="√ñrn: GOLD01" />

          <div class="setup-row">
            <button id="btn-join-room" class="secondary small">Odaya Katƒ±l</button>
          </div>

          <div class="setup-row" style="margin-top:10px;">
            <button id="btn-create-room" class="small">
              üè† Yeni Oda Olu≈ütur
            </button>
            <span id="created-room-code" class="code-badge" style="display:none;"></span>
          </div>

          <div class="small-note">
            Oda kodunu arkada≈ülarƒ±nla payla≈ü. Onlar da aynƒ± kodla girerse leaderboard sadece
            o odadaki oyuncularƒ± g√∂sterir.
          </div>
        </div>
      </div>
    </div>

    <!-- GAME -->
    <div id="game-section" style="display:none; margin-top:16px;">
      <div class="row">
        <!-- LEFT: 3D + controls -->
        <div class="col-wide">
          <div class="mine-panel">
            <canvas id="mine-canvas"></canvas>
            <div class="depth-hud">
              <span>Derinlik:</span>
              <span class="value" id="depth-label">0 m</span>
            </div>
          </div>

          <div class="controls-card">
            <div class="dig-row">
              <button id="btn-dig">‚õèÔ∏è Kaz!</button>
              <div class="stat-line">
                <span>Her tƒ±k:</span>
                <span class="value" id="per-click-label">1 m</span>
              </div>
              <div class="stat-line">
                <span>Oto kazma:</span>
                <span class="value" id="auto-rate-label">0 m/sn</span>
              </div>
            </div>

            <div class="resource-row">
              <div class="resource-chip">
                üí∞ <span>Nakit:</span> <span class="value" id="money-label">0</span>
              </div>
              <div class="resource-chip">
                ü™ô <span>Altƒ±n:</span> <span class="value" id="gold-label">0</span>
              </div>
              <div class="resource-chip">
                üõ¢Ô∏è <span>Petrol:</span> <span class="value" id="oil-label">0</span>
              </div>
              <div class="resource-chip">
                üíé <span>Maden:</span> <span class="value" id="gems-label">0</span>
              </div>
            </div>

            <div class="upgrade-list">
              <div class="upgrade-row">
                <div class="upgrade-main">
                  <div class="upgrade-title">Kazmayƒ± G√º√ßlendir</div>
                  <div class="upgrade-sub">
                    Her tƒ±k ba≈üƒ±na derinliƒüi artƒ±rƒ±r. Seviye:
                    <span id="axe-level-label">1</span>
                  </div>
                </div>
                <button id="btn-upgrade-axe" class="small">
                  Y√ºkselt ¬∑ <span id="axe-cost-label">10</span> üí∞
                </button>
              </div>

              <div class="upgrade-row">
                <div class="upgrade-main">
                  <div class="upgrade-title">ƒ∞≈ü√ßi Kirala</div>
                  <div class="upgrade-sub">
                    S√ºrekli kazsƒ±n. ƒ∞≈ü√ßi:
                    <span id="miners-label">0</span>
                  </div>
                </div>
                <button id="btn-hire-miner" class="small">
                  Kirala ¬∑ <span id="miner-cost-label">25</span> üí∞
                </button>
              </div>

              <div class="upgrade-row">
                <div class="upgrade-main">
                  <div class="upgrade-title">Matkap Kulesi</div>
                  <div class="upgrade-sub">
                    Oto kazma hƒ±zƒ±nƒ± ciddi artƒ±rƒ±r. Seviye:
                    <span id="drill-level-label">0</span>
                  </div>
                </div>
                <button id="btn-upgrade-drill" class="small">
                  Kur ¬∑ <span id="drill-cost-label">100</span> üí∞
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- RIGHT: leaderboard + depth ruler + log -->
        <div class="col">
          <div class="leaderboard-card">
            <div class="leaderboard-header">
              <div>
                <div class="section-title">Leaderboard</div>
                <div id="room-label" class="small-note">Global sƒ±ralama</div>
              </div>
              <div class="leaderboard-toggle">
                <button id="btn-view-global" class="small active">üåç Global</button>
                <button id="btn-view-room" class="small">üè† Oda</button>
              </div>
            </div>

            <div class="leaderboard-list" id="leaderboard-list"></div>
            <button id="btn-refresh-leaderboard" class="small secondary" style="margin-top:6px;">
              ‚Üª Yenile
            </button>

            <div class="small-note" style="margin-top:4px;">
              Online veriler Supabase ile senkronize edilir. Baƒülantƒ± yoksa sadece
              kendi cihazƒ±ndaki ilerlemen saklanƒ±r.
            </div>

            <div class="section-title" style="margin-top:10px;">Derinlik Haritasƒ±</div>
            <div class="depth-ruler" id="depth-ruler">
              <div class="depth-ruler-track"></div>
            </div>
          </div>

          <div class="log" id="log"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script type="module">
  import * as THREE from "https://unpkg.com/three@0.160.0/build/three.module.js";
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  // ===================== Supabase =====================
  const SUPABASE_URL = "https://tkggowekxmnlixwinszl.supabase.co";
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRrZ2dvd2VreG1ubGl4d2luc3psIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3MzI1NjcsImV4cCI6MjA4MDMwODU2N30.y1GSvarl9YyBqMaP8x6SXeD88EJ10gjee4rlr6oLyZg";
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const LS_KEY = "deepmine_state_v1";

  // ===================== State =====================
  const defaultState = {
    playerName: "",
    playerId: null,
    roomCode: null,
    depth: 0,
    gold: 0,
    oil: 0,
    gems: 0,
    money: 0,
    axeLevel: 1,
    miners: 0,
    drillLevel: 0,
    perClick: 1,
    autoRate: 0,
    bestDepthSynced: 0,
  };

  let state = { ...defaultState };
  let sessionStarted = false;
  let leaderboardMode = "global"; // "global" | "room"
  let supabaseOnline = true;
  let lastSyncError = null;

  // cost helpers (simple exponential-ish)
  function axeCost(level) {
    return Math.round(10 * Math.pow(1.8, level - 1));
  }
  function minerCost(count) {
    return Math.round(25 * Math.pow(1.6, count));
  }
  function drillCost(level) {
    return Math.round(100 * Math.pow(2.2, level));
  }

  // ===================== DOM refs =====================
  const setupSection = document.getElementById("setup-section");
  const gameSection = document.getElementById("game-section");
  const setupErrorEl = document.getElementById("setup-error");
  const playerNameInput = document.getElementById("player-name");
  const roomCodeInput = document.getElementById("room-code-input");
  const createdRoomCodeEl = document.getElementById("created-room-code");

  const depthLabel = document.getElementById("depth-label");
  const moneyLabel = document.getElementById("money-label");
  const goldLabel = document.getElementById("gold-label");
  const oilLabel = document.getElementById("oil-label");
  const gemsLabel = document.getElementById("gems-label");
  const perClickLabel = document.getElementById("per-click-label");
  const autoRateLabel = document.getElementById("auto-rate-label");
  const axeLevelLabel = document.getElementById("axe-level-label");
  const minersLabel = document.getElementById("miners-label");
  const drillLevelLabel = document.getElementById("drill-level-label");
  const axeCostLabel = document.getElementById("axe-cost-label");
  const minerCostLabel = document.getElementById("miner-cost-label");
  const drillCostLabel = document.getElementById("drill-cost-label");
  const logEl = document.getElementById("log");

  const onlinePill = document.getElementById("online-pill");
  const onlineStatusText = document.getElementById("online-status-text");
  const roomLabel = document.getElementById("room-label");

  const leaderboardListEl = document.getElementById("leaderboard-list");
  const depthRulerEl = document.getElementById("depth-ruler");

  const btnStartSolo = document.getElementById("btn-start-solo");
  const btnJoinRoom = document.getElementById("btn-join-room");
  const btnCreateRoom = document.getElementById("btn-create-room");
  const btnDig = document.getElementById("btn-dig");
  const btnUpgradeAxe = document.getElementById("btn-upgrade-axe");
  const btnHireMiner = document.getElementById("btn-hire-miner");
  const btnUpgradeDrill = document.getElementById("btn-upgrade-drill");
  const btnViewGlobal = document.getElementById("btn-view-global");
  const btnViewRoom = document.getElementById("btn-view-room");
  const btnRefreshLeaderboard = document.getElementById("btn-refresh-leaderboard");

  function log(msg) {
    const line = document.createElement("div");
    line.className = "log-line";
    const time = new Date().toLocaleTimeString();
    line.textContent = `[${time}] ${msg}`;
    logEl.appendChild(line);
    logEl.scrollTop = logEl.scrollHeight;
  }

  // ===================== Local Storage =====================
  function loadLocalState() {
    try {
      const raw = localStorage.getItem(LS_KEY);
      if (!raw) return;
      const saved = JSON.parse(raw);
      state = { ...defaultState, ...saved };
    } catch (e) {
      console.error("Failed to load state", e);
    }
  }

  function saveLocalState() {
    try {
      localStorage.setItem(LS_KEY, JSON.stringify(state));
    } catch (e) {
      console.error("Failed to save state", e);
    }
  }

  // ===================== Online status UI =====================
  function updateOnlineStatusUI() {
    if (!onlinePill) return;
    if (supabaseOnline) {
      onlinePill.classList.remove("offline");
      onlineStatusText.textContent = "Online / Supabase ile senkronize edilmeye √ßalƒ±≈üƒ±lƒ±yor";
    } else {
      onlinePill.classList.add("offline");
      onlineStatusText.textContent = "Offline ¬∑ Yalnƒ±zca bu cihazda kayƒ±tlƒ±";
    }
  }

  // ===================== Mining logic =====================
  function recalcDerivedStats() {
    state.perClick = 1 + (state.axeLevel - 1) * 0.6;
    state.autoRate = state.miners * 0.4 + state.drillLevel * 1.5;
  }

  function applyMining(amount, isAuto = false) {
    if (amount <= 0) return;
    state.depth += amount;
    if (state.depth < 0) state.depth = 0;

    // simple resource model
    const base = amount;
    const goldGain = base * (0.25 + Math.random() * 0.3);
    const oilGain = base * (0.15 + Math.random() * 0.25);
    const gemGain = Math.random() < 0.02 ? base * (1.5 + Math.random()) : 0;

    state.gold += goldGain;
    state.oil += oilGain;
    state.gems += gemGain;

    const moneyGain = goldGain * 1 + oilGain * 1.5 + gemGain * 6;
    state.money += moneyGain;

    if (!isAuto) {
      log(`+${moneyGain.toFixed(1)} üí∞ (kazma) ¬∑ Derinlik: ${state.depth.toFixed(1)} m`);
    }
  }

  function canAfford(cost) {
    return state.money >= cost;
  }

  function spend(cost) {
    if (!canAfford(cost)) return false;
    state.money -= cost;
    return true;
  }

  function updateStatsUI() {
    depthLabel.textContent = `${state.depth.toFixed(1)} m`;
    moneyLabel.textContent = state.money.toFixed(1);
    goldLabel.textContent = state.gold.toFixed(1);
    oilLabel.textContent = state.oil.toFixed(1);
    gemsLabel.textContent = state.gems.toFixed(1);
    perClickLabel.textContent = `${state.perClick.toFixed(1)} m`;
    autoRateLabel.textContent = `${state.autoRate.toFixed(2)} m/sn`;
    axeLevelLabel.textContent = state.axeLevel;
    minersLabel.textContent = state.miners;
    drillLevelLabel.textContent = state.drillLevel;
    axeCostLabel.textContent = axeCost(state.axeLevel).toFixed(0);
    minerCostLabel.textContent = minerCost(state.miners).toFixed(0);
    drillCostLabel.textContent = drillCost(state.drillLevel).toFixed(0);

    // room label
    if (state.roomCode) {
      roomLabel.textContent = `Oda: ${state.roomCode}`;
    } else {
      roomLabel.textContent = "Global sƒ±ralama";
    }
  }

  // ===================== Three.js =====================
  let scene, camera, renderer;
  let shaftMesh, drillMesh;
  let lastFrameTime = performance.now();
  let digPulse = 0;

  function initThree() {
    const canvas = document.getElementById("mine-canvas");
    const rect = canvas.getBoundingClientRect();

    renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
    renderer.setSize(rect.width, rect.height);
    renderer.setPixelRatio(window.devicePixelRatio || 1);

    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x020617);

    camera = new THREE.PerspectiveCamera(45, rect.width / rect.height, 0.1, 200);
    camera.position.set(8, 6, 10);
    camera.lookAt(0, 0, 0);

    const ambient = new THREE.AmbientLight(0x888888);
    scene.add(ambient);

    const dirLight = new THREE.DirectionalLight(0xfff2cc, 1.2);
    dirLight.position.set(4, 10, 6);
    scene.add(dirLight);

    const groundGeo = new THREE.PlaneGeometry(20, 20);
    const groundMat = new THREE.MeshStandardMaterial({
      color: 0x2c1b10,
      roughness: 0.9,
      metalness: 0.05,
    });
    const ground = new THREE.Mesh(groundGeo, groundMat);
    ground.rotation.x = -Math.PI / 2;
    ground.position.y = 0;
    scene.add(ground);

    const shaftGeo = new THREE.BoxGeometry(4, 40, 4);
    const shaftMat = new THREE.MeshStandardMaterial({
      color: 0x111827,
      roughness: 0.8,
      metalness: 0.1,
    });
    shaftMesh = new THREE.Mesh(shaftGeo, shaftMat);
    shaftMesh.position.set(0, -20, 0);
    scene.add(shaftMesh);

    const drillGroup = new THREE.Group();
    const bodyGeo = new THREE.CylinderGeometry(0.6, 0.6, 1.8, 16);
    const bodyMat = new THREE.MeshStandardMaterial({
      color: 0x94a3b8,
      metalness: 0.7,
      roughness: 0.3,
    });
    const body = new THREE.Mesh(bodyGeo, bodyMat);
    body.position.y = 1.4;
    drillGroup.add(body);

    const bitGeo = new THREE.ConeGeometry(0.5, 1.2, 16);
    const bitMat = new THREE.MeshStandardMaterial({
      color: 0xfacc15,
      metalness: 0.9,
      roughness: 0.2,
    });
    const bit = new THREE.Mesh(bitGeo, bitMat);
    bit.position.y = 0.4;
    bit.rotation.x = Math.PI;
    drillGroup.add(bit);

    drillGroup.position.set(0, 0.1, 0);
    scene.add(drillGroup);
    drillMesh = drillGroup;

    window.addEventListener("resize", () => {
      const r = canvas.getBoundingClientRect();
      camera.aspect = r.width / r.height;
      camera.updateProjectionMatrix();
      renderer.setSize(r.width, r.height);
    });
  }

  function updateThree(dt) {
    if (!scene || !camera || !renderer) return;

    const maxVisualDepth = 100;
    const depthRatio = Math.min(1, state.depth / maxVisualDepth);
    const baseY = 6;
    camera.position.y = baseY - depthRatio * 12;
    camera.lookAt(0, 0, 0);

    if (drillMesh) {
      drillMesh.rotation.y += dt * 2 * (1 + state.autoRate * 0.2);
      if (digPulse > 0) {
        const intensity = digPulse * 0.2;
        drillMesh.position.y = 0.1 + Math.sin(digPulse * Math.PI * 4) * 0.2;
        camera.position.x = 8 + (Math.random() - 0.5) * intensity;
        camera.position.z = 10 + (Math.random() - 0.5) * intensity;
        digPulse -= dt * 2.5;
        if (digPulse < 0) digPulse = 0;
      } else {
        drillMesh.position.y = 0.1;
        camera.position.x = 8;
        camera.position.z = 10;
      }
    }

    renderer.render(scene, camera);
  }

  // ===================== Supabase sync =====================
  async function ensureProfileExists() {
    if (!state.playerName) return;
    if (state.playerId) return;
    try {
      const { data, error } = await supabase
        .from("mg_players")
        .insert({
          name: state.playerName,
          best_depth: state.depth,
          total_gold: state.gold,
          room_code: state.roomCode || null,
          last_online: new Date().toISOString(),
        })
        .select()
        .single();

      if (error) {
        supabaseOnline = false;
        lastSyncError = error.message;
        updateOnlineStatusUI();
        return;
      }
      state.playerId = data.id;
      state.bestDepthSynced = data.best_depth || 0;
      supabaseOnline = true;
      lastSyncError = null;
      updateOnlineStatusUI();
      saveLocalState();
    } catch (e) {
      supabaseOnline = false;
      lastSyncError = e.message;
      updateOnlineStatusUI();
    }
  }

  async function syncProfile() {
    if (!sessionStarted) return;
    if (!state.playerName) return;

    await ensureProfileExists();
    if (!state.playerId) return;

    try {
      const { error } = await supabase
        .from("mg_players")
        .update({
          best_depth: state.depth,
          total_gold: state.gold,
          room_code: state.roomCode || null,
          last_online: new Date().toISOString(),
        })
        .eq("id", state.playerId);

      if (error) {
        supabaseOnline = false;
        lastSyncError = error.message;
      } else {
        supabaseOnline = true;
        lastSyncError = null;
        state.bestDepthSynced = state.depth;
      }
      updateOnlineStatusUI();
      saveLocalState();
    } catch (e) {
      supabaseOnline = false;
      lastSyncError = e.message;
      updateOnlineStatusUI();
    }
  }

  async function loadLeaderboard() {
    if (!supabaseOnline && state.playerId == null) return;

    try {
      let query = supabase
        .from("mg_players")
        .select("*")
        .order("best_depth", { ascending: false })
        .limit(50);

      if (leaderboardMode === "room" && state.roomCode) {
        query = query.eq("room_code", state.roomCode);
      }

      const { data, error } = await query;

      if (error) {
        supabaseOnline = false;
        lastSyncError = error.message;
        updateOnlineStatusUI();
        return;
      }

      supabaseOnline = true;
      lastSyncError = null;
      updateOnlineStatusUI();

      renderLeaderboard(data || []);
      renderDepthRuler(data || []);
    } catch (e) {
      supabaseOnline = false;
      lastSyncError = e.message;
      updateOnlineStatusUI();
    }
  }

  function renderLeaderboard(players) {
    leaderboardListEl.innerHTML = "";
    if (!players.length) {
      const empty = document.createElement("div");
      empty.textContent = "Hen√ºz kayƒ±tlƒ± oyuncu yok.";
      empty.style.color = "#9ca3af";
      empty.style.fontSize = "0.8rem";
      leaderboardListEl.appendChild(empty);
      return;
    }

    players.forEach((p, idx) => {
      const row = document.createElement("div");
      row.className = "lb-row";
      if (state.playerId && p.id === state.playerId) {
        row.classList.add("me");
      }

      const rank = document.createElement("div");
      rank.className = "lb-rank";
      rank.textContent = `${idx + 1}.`;

      const nameCell = document.createElement("div");
      nameCell.className = "lb-name";
      const nameSpan = document.createElement("span");
      nameSpan.textContent = p.name || "Anon";
      nameCell.appendChild(nameSpan);

      if (state.playerId && p.id === state.playerId) {
        const meChip = document.createElement("span");
        meChip.className = "me-chip";
        meChip.textContent = "Sen";
        nameCell.appendChild(meChip);
      }
      if (p.room_code) {
        const rc = document.createElement("span");
        rc.className = "room-code-pill";
        rc.textContent = p.room_code;
        nameCell.appendChild(rc);
      }

      const depthCell = document.createElement("div");
      depthCell.className = "lb-depth";
      depthCell.textContent = `${Number(p.best_depth || 0).toFixed(1)} m`;

      row.appendChild(rank);
      row.appendChild(nameCell);
      row.appendChild(depthCell);
      leaderboardListEl.appendChild(row);
    });
  }

  function renderDepthRuler(players) {
    const markers = depthRulerEl.querySelectorAll(".depth-marker");
    markers.forEach(m => m.remove());

    if (!players.length) return;

    let maxDepth = players.reduce(
      (max, p) => Math.max(max, Number(p.best_depth || 0)),
      0
    );
    if (maxDepth < 1) maxDepth = 1;

    players.slice(0, 20).forEach(p => {
      const depth = Number(p.best_depth || 0);
      const ratio = depth / maxDepth;
      const bottomPercent = 5 + ratio * 90;

      const marker = document.createElement("div");
      marker.className = "depth-marker";
      if (state.playerId && p.id === state.playerId) {
        marker.classList.add("me");
      }
      marker.style.bottom = `${bottomPercent}%`;

      const dot = document.createElement("div");
      dot.className = "dot";
      const label = document.createElement("div");
      label.className = "label";
      label.textContent = `${p.name || "Anon"} ¬∑ ${depth.toFixed(0)} m`;

      marker.appendChild(dot);
      marker.appendChild(label);
      depthRulerEl.appendChild(marker);
    });
  }

  // ===================== Session / setup =====================
  function applyRoomLabel() {
    if (state.roomCode) {
      roomLabel.textContent = `Oda: ${state.roomCode}`;
    } else {
      roomLabel.textContent = "Global sƒ±ralama";
    }
  }

  function startSession() {
    if (!state.playerName) {
      setupErrorEl.textContent = "L√ºtfen ismini yaz.";
      return;
    }
    setupErrorEl.textContent = "";
    sessionStarted = true;
    recalcDerivedStats();
    updateStatsUI();
    applyRoomLabel();
    saveLocalState();

    setupSection.style.display = "none";
    gameSection.style.display = "block";

    log(`Ho≈ü geldin ${state.playerName}! Kazmaya ba≈ülayabilirsin.`);
    if (state.roomCode) {
      log(`Oda kodun: ${state.roomCode}. Bu kodu arkada≈ülarƒ±nla payla≈ü.`);
    }

    // Try to sync & load leaderboard
    syncProfile();
    loadLeaderboard();
  }

  // ===================== Events =====================
  btnStartSolo.addEventListener("click", () => {
    const name = playerNameInput.value.trim();
    if (!name) {
      setupErrorEl.textContent = "L√ºtfen ismini yaz.";
      return;
    }
    state.playerName = name;
    // global, no room code
    startSession();
  });

  btnJoinRoom.addEventListener("click", () => {
    const name = playerNameInput.value.trim();
    const code = roomCodeInput.value.trim().toUpperCase();
    if (!name) {
      setupErrorEl.textContent = "L√ºtfen ismini yaz.";
      return;
    }
    if (!code) {
      setupErrorEl.textContent = "Oda kodu bo≈ü olamaz.";
      return;
    }
    state.playerName = name;
    state.roomCode = code;
    createdRoomCodeEl.style.display = "none";
    startSession();
  });

  btnCreateRoom.addEventListener("click", () => {
    const name = playerNameInput.value.trim();
    if (!name) {
      setupErrorEl.textContent = "√ñnce ismini yaz, sonra oda olu≈ütur.";
      return;
    }
    state.playerName = name;
    const slug = Math.random().toString(36).substring(2, 7).toUpperCase();
    state.roomCode = slug;
    createdRoomCodeEl.style.display = "inline-block";
    createdRoomCodeEl.textContent = `Oda kodun: ${slug}`;
    setupErrorEl.textContent = "Odayƒ± kullanmak i√ßin √ºstten 'Tek ba≈üƒ±ma / Global' deƒüil, 'Odaya Katƒ±l' demene gerek yok; direkt Ba≈ülat diyebilirsin.";
  });

  btnDig.addEventListener("click", () => {
    if (!sessionStarted) return;
    applyMining(state.perClick, false);
    digPulse = 1;
    updateStatsUI();
    saveLocalState();
  });

  btnUpgradeAxe.addEventListener("click", () => {
    if (!sessionStarted) return;
    const cost = axeCost(state.axeLevel);
    if (!spend(cost)) {
      log("Yeterli paran yok (Kazma y√ºkseltme).");
      return;
    }
    state.axeLevel += 1;
    recalcDerivedStats();
    log(`Kazma seviyesi ${state.axeLevel} oldu.`);
    updateStatsUI();
    saveLocalState();
  });

  btnHireMiner.addEventListener("click", () => {
    if (!sessionStarted) return;
    const cost = minerCost(state.miners);
    if (!spend(cost)) {
      log("Yeterli paran yok (ƒ∞≈ü√ßi kiralama).");
      return;
    }
    state.miners += 1;
    recalcDerivedStats();
    log(`Yeni i≈ü√ßi i≈üe alƒ±ndƒ±. Toplam: ${state.miners}.`);
    updateStatsUI();
    saveLocalState();
  });

  btnUpgradeDrill.addEventListener("click", () => {
    if (!sessionStarted) return;
    const cost = drillCost(state.drillLevel);
    if (!spend(cost)) {
      log("Yeterli paran yok (Matkap kulesi).");
      return;
    }
    state.drillLevel += 1;
    recalcDerivedStats();
    log(`Matkap seviyesi ${state.drillLevel} oldu.`);
    updateStatsUI();
    saveLocalState();
  });

  btnViewGlobal.addEventListener("click", () => {
    leaderboardMode = "global";
    btnViewGlobal.classList.add("active");
    btnViewRoom.classList.remove("active");
    loadLeaderboard();
  });

  btnViewRoom.addEventListener("click", () => {
    leaderboardMode = "room";
    btnViewRoom.classList.add("active");
    btnViewGlobal.classList.remove("active");
    loadLeaderboard();
  });

  btnRefreshLeaderboard.addEventListener("click", () => {
    loadLeaderboard();
  });

  // ===================== Game loop =====================
  function loop(now) {
    const dt = (now - lastFrameTime) / 1000;
    lastFrameTime = now;

    if (sessionStarted) {
      if (state.autoRate > 0) {
        applyMining(state.autoRate * dt, true);
      }
      updateStatsUI();
    }

    updateThree(dt);
    requestAnimationFrame(loop);
  }

  // periodic save + sync
  setInterval(() => {
    if (!sessionStarted) return;
    saveLocalState();
    syncProfile();
    if (Math.random() < 0.4) {
      loadLeaderboard();
    }
  }, 15000);

  window.addEventListener("beforeunload", () => {
    saveLocalState();
  });

  // ===================== Init =====================
  loadLocalState();
  updateOnlineStatusUI();
  recalcDerivedStats();
  updateStatsUI();
  if (state.playerName) {
    playerNameInput.value = state.playerName;
  }
  if (state.roomCode) {
    roomCodeInput.value = state.roomCode;
  }

  initThree();
  requestAnimationFrame(loop);
</script>
</body>
</html>
