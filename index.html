<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>DeepMine Online Â· AltÄ±n & Petrol MadenciliÄŸi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #020617;
      --panel: #020617;
      --card: #020617;
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.2);
      --danger: #f97373;
      --text: #e5e7eb;
      --text-soft: #9ca3af;
      --radius: 18px;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
      background: radial-gradient(circle at top, #020617, #000 55%);
      color: var(--text);
      display: flex;
      justify-content: center;
      align-items: stretch;
      min-height: 100vh;
    }

    .app {
      max-width: 1100px;
      width: 100%;
      padding: 24px 16px 32px;
    }

    .card-shell {
      position: relative;
      background: radial-gradient(circle at top, #020617, #020617 40%), var(--card);
      border-radius: var(--radius);
      padding: 20px;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(75, 85, 99, 0.4);
      backdrop-filter: blur(24px);
      overflow: hidden;
    }

    .card-shell > * { position: relative; z-index: 1; }

    .card-shell::after {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: var(--radius);
      background: radial-gradient(circle at 20% 20%, rgba(56, 189, 248, 0.08), transparent 35%),
                  radial-gradient(circle at 80% 0%, rgba(249, 115, 22, 0.12), transparent 30%);
      pointer-events: none;
      opacity: 0.6;
      animation: panelGlow 12s ease-in-out infinite;
      z-index: 0;
    }

    h1 {
      margin-top: 0;
      font-size: 2rem;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    h1 span.icon { font-size: 2.2rem; }

    .subtitle {
      color: var(--text-soft);
      margin-bottom: 12px;
      max-width: 640px;
      font-size: 0.95rem;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      margin-top: 16px;
    }

    .col {
      flex: 1 1 260px;
      min-width: 0;
    }

    .col-wide {
      flex: 1.2 1 340px;
    }

    .section-title {
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-soft);
      margin-bottom: 6px;
    }

    label {
      display: block;
      font-size: 0.8rem;
      color: var(--text-soft);
      margin-bottom: 4px;
    }

    input {
      width: 100%;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid #1f2937;
      background: rgba(15, 23, 42, 0.95);
      color: var(--text);
      font-size: 0.9rem;
      outline: none;
    }

    input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.4);
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 8px 16px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: linear-gradient(to right, #22c55e, #38bdf8);
      color: #0f172a;
      box-shadow: 0 8px 25px rgba(56, 189, 248, 0.45);
      transition: transform 0.1s, box-shadow 0.1s;
      white-space: nowrap;
    }

    button.secondary {
      background: transparent;
      border: 1px solid #4b5563;
      color: var(--text-soft);
      box-shadow: none;
    }

    button.small {
      padding: 6px 10px;
      font-size: 0.78rem;
    }

    button[disabled] {
      opacity: 0.5;
      cursor: default;
      box-shadow: none;
    }

    button:active {
      transform: translateY(1px) scale(0.99);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.75rem;
      border: 1px solid rgba(75, 85, 99, 0.7);
      color: var(--text-soft);
      background: rgba(15, 23, 42, 0.9);
    }

    .pill-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 8px rgba(34, 197, 94, 0.7);
    }

    .pill.offline .pill-dot {
      background: #f97373;
      box-shadow: 0 0 8px rgba(248, 113, 113, 0.7);
    }

    .error {
      color: var(--danger);
      font-size: 0.8rem;
      margin-top: 6px;
    }

    /* THREE.JS PANEL */

    .mine-panel {
      border-radius: 16px;
      border: 1px solid rgba(31, 41, 55, 0.9);
      background: radial-gradient(circle at 20% 0%, #0f172a, #020617 65%);
      padding: 10px;
      position: relative;
      overflow: hidden;
      box-shadow: 0 18px 36px rgba(0, 0, 0, 0.8);
      min-height: 260px;
    }

    #mine-canvas {
      width: 100%;
      height: 260px;
      display: block;
      border-radius: 14px;
      background: linear-gradient(180deg, #0b1220, #0a1020 60%, #060914);
    }

    .minimap-overlay {
      position: absolute;
      top: 12px;
      right: 12px;
      width: 140px;
      height: 100px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      border-radius: 10px;
      pointer-events: none;
      background: radial-gradient(circle at 50% 20%, rgba(59, 130, 246, 0.1), rgba(14, 165, 233, 0.04));
      box-shadow: inset 0 0 12px rgba(14, 165, 233, 0.25);
      color: var(--text-soft);
      font-size: 0.75rem;
      padding: 4px 6px;
    }

    .floating-container {
      position: absolute;
      inset: 0;
      pointer-events: none;
      overflow: hidden;
    }

    .collapse-warning {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(185, 28, 28, 0.25);
      color: #fecdd3;
      font-weight: 700;
      text-align: center;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s;
      backdrop-filter: blur(1px);
    }

    .collapse-warning.active {
      opacity: 1;
      pointer-events: none;
    }

    .floating-text {
      position: absolute;
      color: #facc15;
      font-weight: 700;
      text-shadow: 0 2px 8px rgba(0, 0, 0, 0.45);
      opacity: 0;
      transition: transform 0.8s ease-out, opacity 0.8s ease-out;
      white-space: nowrap;
    }

    .sound-controls {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 6px;
    }

    .toggle-btn {
      padding: 6px 10px;
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: rgba(15, 23, 42, 0.8);
      color: var(--text);
      cursor: pointer;
      font-size: 0.82rem;
    }

    .toggle-btn.active {
      border-color: #38bdf8;
      box-shadow: 0 0 12px rgba(56, 189, 248, 0.4);
      background: rgba(56, 189, 248, 0.1);
      color: #e0f2fe;
    }

    .mine-tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 6px;
    }

    .mine-tab {
      padding: 6px 10px;
      border-radius: 10px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: rgba(15, 23, 42, 0.8);
      color: var(--text);
      cursor: pointer;
      font-size: 0.82rem;
      transition: transform 0.12s, box-shadow 0.12s, border-color 0.12s;
    }

    .mine-tab.active {
      border-color: #38bdf8;
      box-shadow: 0 0 12px rgba(56, 189, 248, 0.35);
      background: rgba(56, 189, 248, 0.15);
      color: #e0f2fe;
    }

    .mine-tab.add {
      border-color: rgba(74, 222, 128, 0.6);
      color: #bbf7d0;
      background: rgba(22, 101, 52, 0.25);
    }

    .depth-hud {
      position: absolute;
      left: 12px;
      top: 12px;
      background: rgba(15, 23, 42, 0.9);
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      padding: 5px 10px;
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .depth-hud span.value {
      font-weight: 700;
      color: #facc15;
    }

    .resource-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      font-size: 0.85rem;
      margin-top: 8px;
    }

    .resource-chip {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.9);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .resource-chip span.value {
      font-weight: 700;
    }

    .controls-card {
      margin-top: 10px;
      border-radius: 14px;
      border: 1px solid rgba(31, 41, 55, 0.9);
      background: rgba(15, 23, 42, 0.96);
      padding: 10px 12px;
      font-size: 0.9rem;
      box-shadow: 0 14px 36px rgba(0, 0, 0, 0.7);
    }

    .dig-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 10px;
    }

    .event-panel {
      margin-top: 6px;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid rgba(185, 28, 28, 0.35);
      background: rgba(127, 29, 29, 0.18);
      display: flex;
      flex-direction: column;
      gap: 6px;
      color: #fecdd3;
    }

    .event-panel:not(.active) {
      opacity: 0.7;
      border-color: rgba(148, 163, 184, 0.3);
      background: rgba(15, 23, 42, 0.2);
      color: var(--text-soft);
    }

    .dig-row button {
      font-size: 1rem;
    }

    .stat-line {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      font-size: 0.85rem;
      color: var(--text-soft);
    }

    .stat-line span.value {
      font-weight: 700;
      color: var(--text);
    }

    .upgrade-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 8px;
    }

    .upgrade-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid rgba(31, 41, 55, 0.9);
      background: rgba(15, 23, 42, 0.95);
      font-size: 0.85rem;
    }

    .upgrade-main {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .upgrade-title {
      font-weight: 600;
    }

    .upgrade-sub {
      color: var(--text-soft);
      font-size: 0.8rem;
    }

    /* LEADERBOARD + DEPTH RULER */

    .leaderboard-card {
      border-radius: 14px;
      border: 1px solid rgba(31, 41, 55, 0.9);
      background: rgba(15, 23, 42, 0.96);
      padding: 10px 12px;
      font-size: 0.85rem;
      box-shadow: 0 14px 36px rgba(0, 0, 0, 0.7);
    }

    .leaderboard-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 6px;
    }

    .leaderboard-toggle {
      display: inline-flex;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      overflow: hidden;
    }

    .leaderboard-toggle button {
      border-radius: 0;
      box-shadow: none;
      padding: 4px 10px;
      font-size: 0.75rem;
    }

    .leaderboard-toggle button.active {
      background: var(--accent);
      color: #020617;
      border-color: transparent;
    }

    .leaderboard-list {
      max-height: 260px;
      overflow-y: auto;
      padding-right: 4px;
      margin-top: 4px;
    }

    .lb-row {
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: 6px;
      padding: 4px 0;
      border-bottom: 1px dashed rgba(31, 41, 55, 0.7);
      align-items: center;
    }

    .lb-row:last-child { border-bottom: none; }

    .lb-row.me {
      background: rgba(56, 189, 248, 0.07);
      border-radius: 8px;
      padding: 4px 6px;
      border: 1px solid rgba(56, 189, 248, 0.2);
    }

    .lb-rank {
      width: 28px;
      text-align: right;
      color: var(--text-soft);
      font-weight: 600;
    }

    .lb-name {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .lb-depth {
      font-weight: 700;
      color: #facc15;
      font-variant-numeric: tabular-nums;
    }

    .me-chip {
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid rgba(56, 189, 248, 0.6);
      font-size: 0.7rem;
      color: var(--accent);
    }

    .room-code-pill {
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      font-size: 0.7rem;
      color: #e5e7eb;
      background: rgba(15, 23, 42, 0.9);
    }

    .depth-ruler {
      position: relative;
      width: 80px;
      height: 260px;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: linear-gradient(to bottom, #0f172a, #020617 40%, #111827 60%, #0b1220 100%);
      margin-top: 8px;
      overflow: hidden;
    }

    .depth-ruler-track {
      position: absolute;
      left: 50%;
      top: 0;
      bottom: 0;
      width: 2px;
      transform: translateX(-50%);
      background: linear-gradient(to bottom, #64748b, #020617);
      opacity: 0.7;
    }

    .depth-marker {
      position: absolute;
      left: 12px;
      transform: translateY(50%);
      font-size: 0.7rem;
      display: flex;
      flex-direction: column;
      gap: 1px;
    }

    .depth-marker .dot {
      width: 10px;
      height: 10px;
      border-radius: 999px;
      border: 2px solid #facc15;
      background: #020617;
      box-shadow: 0 0 10px rgba(250, 204, 21, 0.7);
    }

    .depth-marker .label {
      font-size: 0.7rem;
      color: #e5e7eb;
      white-space: nowrap;
      text-shadow: 0 1px 4px rgba(0, 0, 0, 0.8);
    }

    .depth-marker.me .dot {
      border-color: #38bdf8;
      box-shadow: 0 0 10px rgba(56, 189, 248, 0.9);
    }

    .depth-marker.me .label {
      color: #38bdf8;
    }

    .small-note {
      font-size: 0.72rem;
      color: var(--text-soft);
      margin-top: 4px;
    }

    /* SETUP */

    .setup-grid {
      display: grid;
      grid-template-columns: 1.5fr 1fr;
      gap: 12px;
    }

    @media (max-width: 820px) {
      .setup-grid {
        grid-template-columns: 1fr;
      }
      .col-wide {
        flex-basis: 100%;
      }
    }

    .setup-card {
      border-radius: 14px;
      border: 1px solid rgba(31, 41, 55, 0.9);
      background: rgba(15, 23, 42, 0.96);
      padding: 12px 14px;
      font-size: 0.9rem;
      box-shadow: 0 14px 36px rgba(0, 0, 0, 0.7);
    }

    .setup-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }

    .setup-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 6px;
    }

    .code-badge {
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px dashed rgba(148, 163, 184, 0.7);
      font-size: 0.8rem;
      color: #e5e7eb;
    }

    .log {
      margin-top: 10px;
      font-size: 0.76rem;
      color: var(--text-soft);
      max-height: 110px;
      overflow-y: auto;
      border-radius: 10px;
      border: 1px solid rgba(31, 41, 55, 0.9);
      padding: 6px 8px;
      background: rgba(15, 23, 42, 0.95);
    }

    .log-line { margin-bottom: 2px; }

    @keyframes panelGlow {
      0%, 100% { opacity: 0.5; }
      50% { opacity: 0.9; }
    }
  </style>
</head>
<body>
<div class="app">
  <div class="card-shell">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
      <div>
        <h1>
          <span class="icon">â›ï¸</span>
          <span>DeepMine Online</span>
        </h1>
        <div class="subtitle">
          TÄ±kla, kaz, altÄ±n ve petrol Ã§Ä±kar. KazmanÄ± geliÅŸtir, iÅŸÃ§i ve matkap al,
          sonra her ÅŸeyi otomatiÄŸe baÄŸla. Ä°stersen global, istersen sadece arkadaÅŸlarÄ±nla aynÄ± odada yarÄ±ÅŸ.
        </div>
      </div>
      <div>
        <div id="online-pill" class="pill">
          <div class="pill-dot"></div>
          <span id="online-status-text">Online baÄŸlanmaya Ã§alÄ±ÅŸÄ±lÄ±yor...</span>
        </div>
      </div>
    </div>

    <!-- SETUP -->
    <div id="setup-section" style="margin-top:12px;">
      <div class="setup-grid">
        <div class="setup-card">
          <div class="section-title">Oyuncu</div>
          <label for="player-name">Ä°smin</label>
          <input id="player-name" placeholder="Umut, Nova vs." />

          <div class="setup-row">
            <button id="btn-start-solo">
              ğŸŒ Tek baÅŸÄ±ma / Global
            </button>
          </div>

          <div class="small-note">
            Ä°stediÄŸin zaman online/leaderboard senkronize etmeye Ã§alÄ±ÅŸÄ±r. BaÄŸlantÄ± yoksa
            oyun tamamen cihazÄ±nda Ã§alÄ±ÅŸÄ±r.
          </div>
          <div id="setup-error" class="error"></div>
        </div>

        <div class="setup-card">
          <div class="section-title">Oda (isteÄŸe baÄŸlÄ±)</div>
          <label for="room-code-input">Mevcut bir odaya katÄ±l</label>
          <input id="room-code-input" placeholder="Ã–rn: GOLD01" />

          <div class="setup-row">
            <button id="btn-join-room" class="secondary small">Odaya KatÄ±l</button>
          </div>

          <div class="setup-row" style="margin-top:10px;">
            <button id="btn-create-room" class="small">
              ğŸ  Yeni Oda OluÅŸtur
            </button>
            <span id="created-room-code" class="code-badge" style="display:none;"></span>
          </div>

          <div class="small-note">
            Oda kodunu arkadaÅŸlarÄ±nla paylaÅŸ. Onlar da aynÄ± kodla girerse leaderboard sadece
            o odadaki oyuncularÄ± gÃ¶sterir.
          </div>
        </div>
      </div>
    </div>

    <!-- GAME -->
    <div id="game-section" style="display:none; margin-top:16px;">
      <div class="row">
        <!-- LEFT: 3D + controls -->
        <div class="col-wide">
          <div class="mine-panel">
            <canvas id="mine-canvas"></canvas>
            <div class="depth-hud">
              <span>Derinlik:</span>
              <span class="value" id="depth-label">0 m</span>
            </div>
            <div class="minimap-overlay" aria-hidden="true">Mini-harita</div>
            <div class="collapse-warning" id="collapse-warning">âš ï¸ GÃ¶Ã§Ã¼k! Ä°ÅŸÃ§iler kaÃ§maya Ã§alÄ±ÅŸÄ±yorâ€¦</div>
            <div class="floating-container" id="floating-container"></div>
          </div>

          <div class="controls-card">
            <div class="dig-row">
              <button id="btn-dig">â›ï¸ Kaz!</button>
              <div class="stat-line">
                <span>Her tÄ±k:</span>
                <span class="value" id="per-click-label">1 m</span>
              </div>
              <div class="stat-line">
                <span>Oto kazma:</span>
                <span class="value" id="auto-rate-label">0 m/sn</span>
              </div>
            </div>

            <div class="dig-row" style="margin-top:8px; gap:12px; align-items:flex-start;">
              <button id="btn-charge" class="secondary small">ğŸ’¥ PatlayÄ±cÄ± YÃ¼k</button>
              <div class="stat-line">
                <span>PatlayÄ±cÄ± gÃ¼Ã§:</span>
                <span class="value" id="charge-status">HazÄ±r</span>
              </div>
              <div class="stat-line">
                <span>Bonus Ã§arpan:</span>
                <span class="value" id="charge-mult">x1.0</span>
              </div>
            </div>

            <div class="resource-row">
              <div class="resource-chip">
                ğŸ’° <span>Nakit:</span> <span class="value" id="money-label">0</span>
              </div>
              <div class="resource-chip">
                ğŸª™ <span>AltÄ±n:</span> <span class="value" id="gold-label">0</span>
              </div>
              <div class="resource-chip">
                ğŸ›¢ï¸ <span>Petrol:</span> <span class="value" id="oil-label">0</span>
              </div>
              <div class="resource-chip">
                ğŸ’ <span>Maden:</span> <span class="value" id="gems-label">0</span>
              </div>
            </div>

            <div class="section-title" style="margin-top:8px;">Madenler</div>
            <div class="mine-tabs" id="mine-tabs"></div>

            <div class="sound-controls">
              <button id="btn-toggle-sfx" class="toggle-btn active">ğŸ”Š Ses AÃ§Ä±k</button>
              <button id="btn-toggle-music" class="toggle-btn">ğŸµ MÃ¼zik KapalÄ±</button>
            </div>

            <div class="event-panel" id="event-panel">
              <div id="event-label">GÃ¶Ã§Ã¼k yok, kazmaya devam!</div>
              <div style="display:flex; gap:6px; align-items:center; flex-wrap:wrap;">
                <div id="event-timer">â€“</div>
                <button id="btn-repair" class="small secondary">Onar (200 ğŸ’° + 100 ğŸ›¢ï¸)</button>
              </div>
            </div>

            <div class="upgrade-list">
              <div class="upgrade-row">
                <div class="upgrade-main">
                  <div class="upgrade-title">KazmayÄ± GÃ¼Ã§lendir</div>
                  <div class="upgrade-sub">
                    Her tÄ±k baÅŸÄ±na derinliÄŸi artÄ±rÄ±r. Seviye:
                    <span id="axe-level-label">1</span>
                  </div>
                </div>
                <button id="btn-upgrade-axe" class="small">
                  YÃ¼kselt Â· <span id="axe-cost-label">10</span> ğŸ’°
                </button>
              </div>

              <div class="upgrade-row">
                <div class="upgrade-main">
                  <div class="upgrade-title">Ä°ÅŸÃ§i Kirala</div>
                  <div class="upgrade-sub">
                    SÃ¼rekli kazsÄ±n. Ä°ÅŸÃ§i:
                    <span id="miners-label">0</span>
                  </div>
                </div>
                <button id="btn-hire-miner" class="small">
                  Kirala Â· <span id="miner-cost-label">25</span> ğŸ’°
                </button>
              </div>

              <div class="upgrade-row">
                <div class="upgrade-main">
                  <div class="upgrade-title">Matkap Kulesi</div>
                  <div class="upgrade-sub">
                    Oto kazma hÄ±zÄ±nÄ± ciddi artÄ±rÄ±r. Seviye:
                    <span id="drill-level-label">0</span>
                  </div>
                </div>
                <button id="btn-upgrade-drill" class="small">
                  Kur Â· <span id="drill-cost-label">100</span> ğŸ’°
                </button>
              </div>

              <div class="upgrade-row">
                <div class="upgrade-main">
                  <div class="upgrade-title">Jeo-Radar</div>
                  <div class="upgrade-sub">
                    DeÄŸerli cevher bulma ihtimalini artÄ±rÄ±r. Seviye:
                    <span id="radar-level-label">0</span>
                  </div>
                </div>
                <button id="btn-upgrade-radar" class="small">
                  YÃ¼kselt Â· <span id="radar-cost-label">120</span> ğŸ’°
                </button>
              </div>

              <div class="upgrade-row">
                <div class="upgrade-main">
                  <div class="upgrade-title">Ã‡Ä±karma VerimliliÄŸi</div>
                  <div class="upgrade-sub">
                    KazanÃ§ Ã§arpanÄ±nÄ± yÃ¼kseltir. Seviye:
                    <span id="efficiency-level-label">0</span>
                  </div>
                </div>
                <button id="btn-upgrade-efficiency" class="small">
                  YÃ¼kselt Â· <span id="efficiency-cost-label">150</span> ğŸ’°
                </button>
              </div>

              <div class="section-title" style="margin-top:10px;">Ã–zel YÃ¼kseltmeler (AltÄ±n &amp; Maden)</div>
              <div class="upgrade-row">
                <div class="upgrade-main">
                  <div class="upgrade-title">Sonsuz AsansÃ¶r</div>
                  <div class="upgrade-sub">TÃ¼m madenlerde oto kazma +%20</div>
                </div>
                <button id="btn-upgrade-elevator" class="small">
                  Al Â· <span id="elevator-cost">300 ğŸª™ + 20 ğŸ’</span>
                </button>
              </div>
              <div class="upgrade-row">
                <div class="upgrade-main">
                  <div class="upgrade-title">Patlama StabilizÃ¶rÃ¼</div>
                  <div class="upgrade-sub">GÃ¶Ã§Ã¼k cezasÄ±nÄ± azaltÄ±r</div>
                </div>
                <button id="btn-upgrade-stabilizer" class="small">
                  Al Â· <span id="stabilizer-cost">250 ğŸª™ + 10 ğŸ’</span>
                </button>
              </div>
              <div class="upgrade-row">
                <div class="upgrade-main">
                  <div class="upgrade-title">Kristal Bilgi Merkezi</div>
                  <div class="upgrade-sub">Maden bulma ihtimali +%30</div>
                </div>
                <button id="btn-upgrade-crystallab" class="small">
                  Al Â· <span id="crystallab-cost">500 ğŸª™ + 35 ğŸ’</span>
                </button>
              </div>
              <div class="upgrade-row">
                <div class="upgrade-main">
                  <div class="upgrade-title">LÃ¼ks Ekipman</div>
                  <div class="upgrade-sub">Her seviye tÄ±k gÃ¼cÃ¼ne +%5</div>
                </div>
                <button id="btn-upgrade-luxury" class="small">
                  Al Â· <span id="luxury-cost">100 ğŸª™ + 5 ğŸ’</span>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- RIGHT: leaderboard + depth ruler + log -->
        <div class="col">
          <div class="leaderboard-card">
            <div class="leaderboard-header">
              <div>
                <div class="section-title">Leaderboard</div>
                <div id="room-label" class="small-note">Global sÄ±ralama</div>
              </div>
              <div class="leaderboard-toggle">
                <button id="btn-view-global" class="small active">ğŸŒ Global</button>
                <button id="btn-view-room" class="small">ğŸ  Oda</button>
              </div>
            </div>

            <div class="leaderboard-list" id="leaderboard-list"></div>
            <button id="btn-refresh-leaderboard" class="small secondary" style="margin-top:6px;">
              â†» Yenile
            </button>

            <div class="small-note" style="margin-top:4px;">
              Online veriler Supabase ile senkronize edilir. BaÄŸlantÄ± yoksa sadece
              kendi cihazÄ±ndaki ilerlemen saklanÄ±r.
            </div>

            <div class="section-title" style="margin-top:10px;">Derinlik HaritasÄ±</div>
            <div class="depth-ruler" id="depth-ruler">
              <div class="depth-ruler-track"></div>
            </div>
          </div>

          <div class="log" id="log"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<script type="module">
  import * as THREE from "https://unpkg.com/three@0.164.1/build/three.module.js";
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  // ===================== Supabase =====================
  const SUPABASE_URL = "https://tkggowekxmnlixwinszl.supabase.co";
  const SUPABASE_ANON_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRrZ2dvd2VreG1ubGl4d2luc3psIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3MzI1NjcsImV4cCI6MjA4MDMwODU2N30.y1GSvarl9YyBqMaP8x6SXeD88EJ10gjee4rlr6oLyZg";
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const LS_KEY = "deepmine_state_v1";

  // ===================== State =====================
  const MINE_PRESETS = [
    { id: "main", name: "Ana Maden", goldBonus: 1, oilBonus: 1, gemBonus: 1, collapseRisk: 0.0 },
    { id: "deep_gold", name: "AltÄ±n DamarÄ±", goldBonus: 1.8, oilBonus: 0.7, gemBonus: 1.2, collapseRisk: 0.03 },
    { id: "oil_field", name: "Petrol Ã‡ukuru", goldBonus: 0.6, oilBonus: 2.0, gemBonus: 1.0, collapseRisk: 0.04 },
    { id: "crystal_cave", name: "Kristal MaÄŸara", goldBonus: 0.9, oilBonus: 0.8, gemBonus: 2.2, collapseRisk: 0.06 },
  ];

  const defaultState = {
    playerName: "",
    playerId: null,
    roomCode: null,
    currentMineId: "main",
    mines: {
      main: {
        id: "main",
        name: "Ana Maden",
        depth: 0,
        axeLevel: 1,
        miners: 0,
        drillLevel: 0,
        radarLevel: 0,
        efficiencyLevel: 0,
      },
    },
    gold: 0,
    oil: 0,
    gems: 0,
    money: 0,
    chargeReadyAt: 0,
    chargeActiveUntil: 0,
    soundEnabled: true,
    musicEnabled: false,
    perClick: 1,
    autoRate: 0,
    bestDepthSynced: 0,
    specialUpgrades: {
      elevator: false,
      stabilizer: 0,
      crystalLab: false,
      luxury: 0,
    },
    stabilityBuffUntil: 0,
    currentEvent: {
      type: null,
      endsAt: 0,
      penaltyApplied: false,
      mineId: null,
    },
  };

  let state = { ...defaultState, specialUpgrades: { ...defaultState.specialUpgrades }, currentEvent: { ...defaultState.currentEvent } };
  let sessionStarted = false;
  let leaderboardMode = "global"; // "global" | "room"
  let supabaseOnline = true;
  let lastSyncError = null;
  let prevChargeActive = false;
  let userInteracted = false;

  function getMinePreset(id) {
    return MINE_PRESETS.find((m) => m.id === id) || MINE_PRESETS[0];
  }

  function getCurrentMine() {
    return state.mines[state.currentMineId];
  }

  function updateCurrentMine(updater) {
    const mine = getCurrentMine();
    if (!mine) return;
    updater(mine);
  }

  function bestDepthAcrossMines() {
    return Math.max(0, ...Object.values(state.mines || {}).map((m) => m.depth || 0));
  }

  function markInteraction() {
    if (userInteracted) return;
    userInteracted = true;
    soundManager.ensureUnlocked();
    soundManager.updateMusicState();
  }

  // cost helpers (simple exponential-ish)
  function axeCost(level) {
    return Math.round(12 * Math.pow(1.95, level - 1));
  }
  function minerCost(count) {
    return Math.round(30 * Math.pow(1.75, count));
  }
  function drillCost(level) {
    return Math.round(120 * Math.pow(2.35, level));
  }
  function radarCost(level) {
    return Math.round(150 * Math.pow(1.85, level));
  }
  function efficiencyCost(level) {
    return Math.round(200 * Math.pow(1.75, level));
  }

  // ===================== DOM refs =====================
  const setupSection = document.getElementById("setup-section");
  const gameSection = document.getElementById("game-section");
  const setupErrorEl = document.getElementById("setup-error");
  const playerNameInput = document.getElementById("player-name");
  const roomCodeInput = document.getElementById("room-code-input");
  const createdRoomCodeEl = document.getElementById("created-room-code");

  const depthLabel = document.getElementById("depth-label");
  const moneyLabel = document.getElementById("money-label");
  const goldLabel = document.getElementById("gold-label");
  const oilLabel = document.getElementById("oil-label");
  const gemsLabel = document.getElementById("gems-label");
  const perClickLabel = document.getElementById("per-click-label");
  const autoRateLabel = document.getElementById("auto-rate-label");
  const axeLevelLabel = document.getElementById("axe-level-label");
  const minersLabel = document.getElementById("miners-label");
  const drillLevelLabel = document.getElementById("drill-level-label");
  const radarLevelLabel = document.getElementById("radar-level-label");
  const efficiencyLevelLabel = document.getElementById("efficiency-level-label");
  const axeCostLabel = document.getElementById("axe-cost-label");
  const minerCostLabel = document.getElementById("miner-cost-label");
  const drillCostLabel = document.getElementById("drill-cost-label");
  const radarCostLabel = document.getElementById("radar-cost-label");
  const efficiencyCostLabel = document.getElementById("efficiency-cost-label");
  const logEl = document.getElementById("log");
  const floatingContainer = document.getElementById("floating-container");
  const chargeStatusEl = document.getElementById("charge-status");
  const chargeMultEl = document.getElementById("charge-mult");

  const onlinePill = document.getElementById("online-pill");
  const onlineStatusText = document.getElementById("online-status-text");
  const roomLabel = document.getElementById("room-label");

  const leaderboardListEl = document.getElementById("leaderboard-list");
  const depthRulerEl = document.getElementById("depth-ruler");
  const mineTabsEl = document.getElementById("mine-tabs");
  const collapseWarningEl = document.getElementById("collapse-warning");
  const eventPanel = document.getElementById("event-panel");
  const eventLabel = document.getElementById("event-label");
  const eventTimer = document.getElementById("event-timer");
  const btnRepair = document.getElementById("btn-repair");

  const btnUpgradeElevator = document.getElementById("btn-upgrade-elevator");
  const btnUpgradeStabilizer = document.getElementById("btn-upgrade-stabilizer");
  const btnUpgradeCrystalLab = document.getElementById("btn-upgrade-crystallab");
  const btnUpgradeLuxury = document.getElementById("btn-upgrade-luxury");
  const elevatorCostLabel = document.getElementById("elevator-cost");
  const stabilizerCostLabel = document.getElementById("stabilizer-cost");
  const crystalLabCostLabel = document.getElementById("crystallab-cost");
  const luxuryCostLabel = document.getElementById("luxury-cost");

  const btnStartSolo = document.getElementById("btn-start-solo");
  const btnJoinRoom = document.getElementById("btn-join-room");
  const btnCreateRoom = document.getElementById("btn-create-room");
  const btnDig = document.getElementById("btn-dig");
  const btnUpgradeAxe = document.getElementById("btn-upgrade-axe");
  const btnHireMiner = document.getElementById("btn-hire-miner");
  const btnUpgradeDrill = document.getElementById("btn-upgrade-drill");
  const btnUpgradeRadar = document.getElementById("btn-upgrade-radar");
  const btnUpgradeEfficiency = document.getElementById("btn-upgrade-efficiency");
  const btnToggleSfx = document.getElementById("btn-toggle-sfx");
  const btnToggleMusic = document.getElementById("btn-toggle-music");
  const btnCharge = document.getElementById("btn-charge");
  const btnViewGlobal = document.getElementById("btn-view-global");
  const btnViewRoom = document.getElementById("btn-view-room");
  const btnRefreshLeaderboard = document.getElementById("btn-refresh-leaderboard");

  function log(msg) {
    const line = document.createElement("div");
    line.className = "log-line";
    const time = new Date().toLocaleTimeString();
    line.textContent = `[${time}] ${msg}`;
    logEl.appendChild(line);
    logEl.scrollTop = logEl.scrollHeight;
  }

  const soundManager = (() => {
    let unlocked = false;
    const createSound = (src, loop = false, volume = 0.8) => {
      try {
        const a = new Audio(src);
        a.loop = loop;
        a.volume = volume;
        return a;
      } catch (e) {
        console.warn("Ses yÃ¼klenemedi", src, e);
        return null;
      }
    };

    const sounds = {
      dig: createSound("sounds/dig.mp3", false, 0.75),
      upgrade: createSound("sounds/upgrade.wav", false, 0.8),
      cash: createSound("sounds/cash.mp3", false, 0.7),
      gem: createSound("sounds/gem.wav", false, 0.6),
      music: createSound("sounds/bg-music.mp3", true, 0.3),
    };

    function ensureUnlocked() {
      if (unlocked) return;
      unlocked = true;
    }

    function playSound(key) {
      if (!state.soundEnabled || !userInteracted) return;
      const s = sounds[key];
      if (!s) return;
      ensureUnlocked();
      try {
        s.currentTime = 0;
        s.play();
      } catch (e) {
        /* ignore */
      }
    }

    function updateMusicState() {
      const m = sounds.music;
      if (!m) return;
      if (state.musicEnabled && state.soundEnabled && userInteracted) {
        ensureUnlocked();
        m.volume = 0.25;
        m.play().catch(() => {});
      } else {
        m.pause();
      }
    }

    return {
      playDig() {
        playSound("dig");
      },
      playUpgrade() {
        playSound("upgrade");
      },
      playMoney() {
        playSound("cash");
      },
      playGem() {
        playSound("gem");
      },
      toggleMute() {
        state.soundEnabled = !state.soundEnabled;
        if (!state.soundEnabled && sounds.music) sounds.music.pause();
        updateMusicState();
        saveLocalState();
        updateStatsUI();
      },
      toggleMusic() {
        state.musicEnabled = !state.musicEnabled;
        updateMusicState();
        saveLocalState();
        updateStatsUI();
      },
      updateMusicState,
      ensureUnlocked,
    };
  })();

  // ===================== Local Storage =====================
  function loadLocalState() {
    try {
      const raw = localStorage.getItem(LS_KEY);
      if (!raw) return;
      const saved = JSON.parse(raw);
      state = { ...defaultState, ...saved };

      // migrate old flat fields
      if (!state.mines) {
        state.mines = {
          main: {
            id: "main",
            name: "Ana Maden",
            depth: saved.depth || 0,
            axeLevel: saved.axeLevel || 1,
            miners: saved.miners || 0,
            drillLevel: saved.drillLevel || 0,
            radarLevel: saved.radarLevel || 0,
            efficiencyLevel: saved.efficiencyLevel || 0,
          },
        };
        state.currentMineId = "main";
      }
      // merge missing defaults inside mines
      Object.values(state.mines).forEach((mine) => {
        mine.axeLevel ??= 1;
        mine.miners ??= 0;
        mine.drillLevel ??= 0;
        mine.radarLevel ??= 0;
        mine.efficiencyLevel ??= 0;
        mine.depth ??= 0;
        mine.name ??= getMinePreset(mine.id)?.name || "Maden";
      });

      state.specialUpgrades = { ...defaultState.specialUpgrades, ...(state.specialUpgrades || {}) };
      state.currentEvent = { ...defaultState.currentEvent, ...(state.currentEvent || {}) };
      state.stabilityBuffUntil = state.stabilityBuffUntil || 0;
    } catch (e) {
      console.error("Failed to load state", e);
    }
  }

  function saveLocalState() {
    try {
      localStorage.setItem(LS_KEY, JSON.stringify(state));
    } catch (e) {
      console.error("Failed to save state", e);
    }
  }

  function isCollapseActive() {
    return (
      state.currentEvent &&
      state.currentEvent.type === "collapse" &&
      state.currentEvent.mineId === state.currentMineId &&
      Date.now() < state.currentEvent.endsAt
    );
  }

  function updateEventUI() {
    if (!eventPanel) return;
    if (isCollapseActive()) {
      eventPanel.classList.add("active");
      const remaining = Math.max(0, state.currentEvent.endsAt - Date.now());
      eventLabel.textContent = "âš ï¸ GÃ¶Ã§Ã¼k! Ä°ÅŸÃ§iler kaÃ§maya Ã§alÄ±ÅŸÄ±yorâ€¦";
      eventTimer.textContent = `${(remaining / 1000).toFixed(1)} sn`;
      collapseWarningEl.classList.add("active");
    } else {
      collapseWarningEl.classList.remove("active");
      eventLabel.textContent = "GÃ¶Ã§Ã¼k yok, kazmaya devam!";
      eventTimer.textContent = "â€“";
      eventPanel.classList.remove("active");
    }
  }

  function renderMineTabs() {
    if (!mineTabsEl) return;
    mineTabsEl.innerHTML = "";
    Object.values(state.mines).forEach((mine) => {
      const btn = document.createElement("button");
      btn.className = "mine-tab";
      if (mine.id === state.currentMineId) btn.classList.add("active");
      btn.textContent = mine.name;
      btn.addEventListener("click", () => {
        state.currentMineId = mine.id;
        recalcDerivedStats();
        updateStatsUI();
        renderMineTabs();
        log(`${mine.name} seÃ§ildi.`);
        saveLocalState();
      });
      mineTabsEl.appendChild(btn);
    });

    const nextPreset = MINE_PRESETS.find((p) => !state.mines[p.id]);
    if (nextPreset) {
      const addBtn = document.createElement("button");
      addBtn.className = "mine-tab add";
      addBtn.textContent = "+ Yeni Åaft AÃ§";
      addBtn.addEventListener("click", () => {
        unlockNextMine();
      });
      mineTabsEl.appendChild(addBtn);
    }
  }

  function unlockNextMine() {
    const unlockedExtras = Math.max(0, Object.keys(state.mines).length - 1);
    const cost = unlockedExtras === 0 ? { money: 500, gold: 200 } : { money: 2000, oil: 400, gems: 40 };
    if (state.money < (cost.money || 0) || state.gold < (cost.gold || 0) || state.oil < (cost.oil || 0) || state.gems < (cost.gems || 0)) {
      log("KaynaklarÄ±n yeni ÅŸaft iÃ§in yetersiz.");
      return;
    }
    const preset = MINE_PRESETS.find((p) => !state.mines[p.id]);
    if (!preset) return;
    state.money -= cost.money || 0;
    state.gold -= cost.gold || 0;
    state.oil -= cost.oil || 0;
    state.gems -= cost.gems || 0;

    state.mines[preset.id] = {
      id: preset.id,
      name: preset.name,
      depth: 0,
      axeLevel: 1,
      miners: 0,
      drillLevel: 0,
      radarLevel: 0,
      efficiencyLevel: 0,
    };
    state.currentMineId = preset.id;
    recalcDerivedStats();
    renderMineTabs();
    updateStatsUI();
    log(`Yeni maden aÃ§Ä±ldÄ±: ${preset.name}`);
    soundManager.playUpgrade();
    saveLocalState();
  }

  function triggerCollapse() {
    const mine = getCurrentMine();
    if (!mine) return;
    state.currentEvent = {
      type: "collapse",
      endsAt: Date.now() + 25000,
      penaltyApplied: false,
      mineId: mine.id,
    };
    shakeStrength = 1.5;
    shakeTime = 1.2;
    log(`âš ï¸ GÃ¶Ã§Ã¼k! ${mine.name} kapandÄ±, iÅŸÃ§iler kaÃ§Ä±yor.`);
    soundManager.playUpgrade();
    updateEventUI();
  }

  function resolveCollapse(paid = false) {
    if (!state.currentEvent || state.currentEvent.type !== "collapse") return;
    if (paid) {
      state.stabilityBuffUntil = Date.now() + 60000;
      log("OnarÄ±m yapÄ±ldÄ±, kÄ±sa sÃ¼reli stabilite bonusu aktif!");
    } else {
      log("GÃ¶Ã§Ã¼k sona erdi, kazmaya dÃ¶n! ");
    }
    state.currentEvent = { ...defaultState.currentEvent };
    recalcDerivedStats();
    updateEventUI();
    soundManager.playUpgrade();
    saveLocalState();
  }

  function maybeTriggerCollapse(dt) {
    const mine = getCurrentMine();
    if (!mine || isCollapseActive()) return;
    if (mine.depth < 160) return;
    const preset = getMinePreset(mine.id);
    const stabilizerCut = state.specialUpgrades.stabilizer ? 0.6 : 1;
    const risk = (preset.collapseRisk || 0.01) * (1 + mine.depth / 600) * stabilizerCut;
    const chance = risk * dt;
    if (Math.random() < chance) {
      triggerCollapse();
    }
  }

  // ===================== Online status UI =====================
  function updateOnlineStatusUI() {
    if (!onlinePill) return;
    if (supabaseOnline) {
      onlinePill.classList.remove("offline");
      onlineStatusText.textContent = "Online / Supabase ile senkronize edilmeye Ã§alÄ±ÅŸÄ±lÄ±yor";
    } else {
      onlinePill.classList.add("offline");
      onlineStatusText.textContent = "Offline Â· YalnÄ±zca bu cihazda kayÄ±tlÄ±";
    }
  }

  // ===================== Mining logic =====================
  function isChargeActive() {
    return Date.now() < state.chargeActiveUntil;
  }

  function nextChargeReadyInMs() {
    return Math.max(0, state.chargeReadyAt - Date.now());
  }

  function chargeMultiplier() {
    const mine = getCurrentMine();
    if (!mine) return 1;
    return 2 + mine.drillLevel * 0.15 + mine.radarLevel * 0.05;
  }

  function recalcDerivedStats() {
    const mine = getCurrentMine();
    if (!mine) return;
    const luxuryBoost = 1 + (state.specialUpgrades.luxury || 0) * 0.05;
    const efficiencyBoost = 1 + mine.efficiencyLevel * 0.07;
    const basePerClick = (1 + (mine.axeLevel - 1) * 0.65) * luxuryBoost;
    const activeChargeBoost = isChargeActive() ? chargeMultiplier() : 1;
    state.perClick = basePerClick * efficiencyBoost * activeChargeBoost;
    let autoBase = mine.miners * 0.32 + mine.drillLevel * 1.4;
    autoBase *= 1 + mine.efficiencyLevel * 0.05;
    if (state.specialUpgrades.elevator) autoBase *= 1.2;
    if (Date.now() < state.stabilityBuffUntil) autoBase *= 1.1;
    state.autoRate = isCollapseActive() ? 0 : autoBase;
  }

  function applyMining(amount, isAuto = false) {
    const mine = getCurrentMine();
    if (!mine || amount <= 0)
      return { moneyGain: 0, goldGain: 0, oilGain: 0, gemGain: 0 };

    mine.depth += amount;
    if (mine.depth < 0) mine.depth = 0;

    const preset = getMinePreset(mine.id);
    const base = amount;
    const depthFactor = 1 + mine.depth * 0.00055;
    const goldGain = base * (0.25 + Math.random() * 0.28) * depthFactor * preset.goldBonus;
    const oilGain = base * (0.16 + Math.random() * 0.25) * (1 + mine.radarLevel * 0.05) * preset.oilBonus;
    const crystalBoost = state.specialUpgrades.crystalLab ? 0.3 : 0;
    const gemChance = 0.02 + mine.radarLevel * 0.01 + crystalBoost + Math.min(0.18, mine.depth / 3800);
    const gemGain = Math.random() < gemChance ? base * (1.4 + Math.random() * (1 + mine.radarLevel * 0.35)) * preset.gemBonus : 0;

    state.gold += goldGain;
    state.oil += oilGain;
    state.gems += gemGain;

    const moneyGainRaw = goldGain * 1 + oilGain * 1.45 + gemGain * 6.5;
    const moneyGain = moneyGainRaw * (1 + mine.efficiencyLevel * 0.12);
    state.money += moneyGain;

    if (!isAuto) {
      log(`+${moneyGain.toFixed(1)} ğŸ’° (kazma) Â· Derinlik: ${mine.depth.toFixed(1)} m`);
    }

    return { moneyGain, goldGain, oilGain, gemGain };
  }

  function canAfford(cost) {
    return state.money >= cost;
  }

  function spend(cost) {
    if (!canAfford(cost)) return false;
    state.money -= cost;
    return true;
  }

  function updateStatsUI() {
    const mine = getCurrentMine();
    if (!mine) return;
    depthLabel.textContent = `${mine.depth.toFixed(1)} m`;
    moneyLabel.textContent = state.money.toFixed(1);
    goldLabel.textContent = state.gold.toFixed(1);
    oilLabel.textContent = state.oil.toFixed(1);
    gemsLabel.textContent = state.gems.toFixed(1);
    perClickLabel.textContent = `${state.perClick.toFixed(1)} m`;
    autoRateLabel.textContent = `${state.autoRate.toFixed(2)} m/sn`;
    axeLevelLabel.textContent = mine.axeLevel;
    minersLabel.textContent = mine.miners;
    drillLevelLabel.textContent = mine.drillLevel;
    radarLevelLabel.textContent = mine.radarLevel;
    efficiencyLevelLabel.textContent = mine.efficiencyLevel;
    axeCostLabel.textContent = axeCost(mine.axeLevel).toFixed(0);
    minerCostLabel.textContent = minerCost(mine.miners).toFixed(0);
    drillCostLabel.textContent = drillCost(mine.drillLevel).toFixed(0);
    radarCostLabel.textContent = radarCost(mine.radarLevel).toFixed(0);
    efficiencyCostLabel.textContent = efficiencyCost(mine.efficiencyLevel).toFixed(0);

    elevatorCostLabel.textContent = "300 ğŸª™ + 20 ğŸ’";
    stabilizerCostLabel.textContent = "250 ğŸª™ + 10 ğŸ’";
    crystalLabCostLabel.textContent = "500 ğŸª™ + 35 ğŸ’";
    luxuryCostLabel.textContent = `100 ğŸª™ + 5 ğŸ’ (Lv.${state.specialUpgrades.luxury || 0})`;

    const readyIn = nextChargeReadyInMs();
    if (isChargeActive()) {
      chargeStatusEl.textContent = "AKTÄ°F";
      chargeStatusEl.style.color = "#facc15";
    } else if (readyIn <= 0) {
      chargeStatusEl.textContent = "HazÄ±r";
      chargeStatusEl.style.color = "#22c55e";
    } else {
      chargeStatusEl.textContent = `${(readyIn / 1000).toFixed(1)} sn`;
      chargeStatusEl.style.color = "#f97373";
    }
    chargeMultEl.textContent = `x${chargeMultiplier().toFixed(1)}`;

    btnCharge.disabled = readyIn > 0 && !isChargeActive();
    btnCharge.classList.toggle("active", isChargeActive());

    btnToggleSfx.classList.toggle("active", state.soundEnabled);
    btnToggleSfx.textContent = state.soundEnabled ? "ğŸ”Š Ses AÃ§Ä±k" : "ğŸ”ˆ Ses KapalÄ±";
    btnToggleMusic.classList.toggle("active", state.musicEnabled);
    btnToggleMusic.textContent = state.musicEnabled ? "ğŸµ MÃ¼zik AÃ§Ä±k" : "ğŸµ MÃ¼zik KapalÄ±";

    // room label
    if (state.roomCode) {
      roomLabel.textContent = `Oda: ${state.roomCode}`;
    } else {
      roomLabel.textContent = "Global sÄ±ralama";
    }

    const collapse = isCollapseActive();
    btnDig.disabled = collapse;
    btnUpgradeAxe.disabled = !canAfford(axeCost(mine.axeLevel));
    btnHireMiner.disabled = !canAfford(minerCost(mine.miners));
    btnUpgradeDrill.disabled = !canAfford(drillCost(mine.drillLevel));
    btnUpgradeRadar.disabled = !canAfford(radarCost(mine.radarLevel));
    btnUpgradeEfficiency.disabled = !canAfford(efficiencyCost(mine.efficiencyLevel));

    btnUpgradeElevator.disabled = state.specialUpgrades.elevator || state.gold < 300 || state.gems < 20;
    btnUpgradeStabilizer.disabled = state.specialUpgrades.stabilizer >= 1 || state.gold < 250 || state.gems < 10;
    btnUpgradeCrystalLab.disabled = state.specialUpgrades.crystalLab || state.gold < 500 || state.gems < 35;
    btnUpgradeLuxury.disabled = state.gold < 100 || state.gems < 5;

    updateEventUI();
  }

  // ===================== Three.js =====================
  let scene, camera, minimapCamera, renderer;
  let shaftGroup, drillMesh, minerGroup, minerArmL, minerArmR, pickaxeMesh;
  let oreDecorations = [];
  let dustParticles = [];
  let minimapMarker;
  let lastFrameTime = performance.now();
  let digPulse = 0;
  let shakeTime = 0;
  let shakeStrength = 0;
  let minerDigTimer = 0;
  let autoDigTimer = 0;
  let autoSoundTimer = 0;
  let depthTargetY = 0;
  let targetYaw = -0.6;
  let currentYaw = -0.6;
  let targetPitch = -0.22;
  let currentPitch = -0.22;
  let isDragging = false;
  let dragStart = { x: 0, y: 0 };
  const tempVec = new THREE.Vector3();

  const dustMaterial = new THREE.MeshStandardMaterial({
    color: 0xc4b5a1,
    roughness: 0.9,
    metalness: 0.05,
  });

  function createGroundTexture() {
    const size = 64;
    const canvas = document.createElement("canvas");
    canvas.width = canvas.height = size;
    const ctx = canvas.getContext("2d");
    for (let y = 0; y < 8; y++) {
      for (let x = 0; x < 8; x++) {
        ctx.fillStyle = (x + y) % 2 === 0 ? "#3a2a1d" : "#2f2218";
        ctx.fillRect((x * size) / 8, (y * size) / 8, size / 8, size / 8);
      }
    }
    const tex = new THREE.CanvasTexture(canvas);
    tex.wrapS = tex.wrapT = THREE.RepeatWrapping;
    tex.repeat.set(8, 8);
    tex.anisotropy = 4;
    return tex;
  }

  function buildMiner() {
    const group = new THREE.Group();
    const bodyMat = new THREE.MeshStandardMaterial({ color: 0x334155, roughness: 0.6, metalness: 0.1 });
    const skinMat = new THREE.MeshStandardMaterial({ color: 0xf5d0a3 });
    const accentMat = new THREE.MeshStandardMaterial({ color: 0xf59e0b, emissive: 0x3b82f6 });

    const body = new THREE.Mesh(new THREE.BoxGeometry(0.8, 1.1, 0.45), bodyMat);
    body.position.y = 0.8;
    group.add(body);

    const head = new THREE.Mesh(new THREE.BoxGeometry(0.6, 0.6, 0.6), skinMat);
    head.position.set(0, 1.45, 0);
    group.add(head);

    const helmet = new THREE.Mesh(new THREE.CylinderGeometry(0.35, 0.32, 0.2, 12), accentMat);
    helmet.position.set(0, 1.75, 0);
    group.add(helmet);

    const legGeo = new THREE.BoxGeometry(0.2, 0.7, 0.25);
    const legL = new THREE.Mesh(legGeo, bodyMat);
    legL.position.set(-0.2, 0.35, 0.05);
    const legR = legL.clone();
    legR.position.x = 0.2;
    group.add(legL, legR);

    const armGeo = new THREE.BoxGeometry(0.18, 0.6, 0.18);
    minerArmL = new THREE.Mesh(armGeo, skinMat);
    minerArmL.position.set(-0.5, 1.05, 0);
    minerArmR = new THREE.Mesh(armGeo, skinMat);
    minerArmR.position.set(0.5, 1.05, 0);
    group.add(minerArmL, minerArmR);

    const pickGeo = new THREE.BoxGeometry(0.9, 0.12, 0.12);
    const pickMat = new THREE.MeshStandardMaterial({ color: 0xb3b3b3, metalness: 0.8, roughness: 0.3 });
    pickaxeMesh = new THREE.Mesh(pickGeo, pickMat);
    pickaxeMesh.position.set(0.6, 0, 0);
    minerArmR.add(pickaxeMesh);

    group.position.set(-2.5, 0.4, 2.3);
    group.rotation.y = -Math.PI / 4;
    return group;
  }

  function createOreBlock(type, depth) {
    let mat;
    let geo;
    if (type === "gold") {
      mat = new THREE.MeshStandardMaterial({ color: 0xfbbf24, emissive: 0x854d0e, metalness: 0.6, roughness: 0.3 });
      geo = new THREE.BoxGeometry(0.6, 0.6, 0.6);
    } else if (type === "oil") {
      mat = new THREE.MeshStandardMaterial({ color: 0x0f172a, metalness: 0.9, roughness: 0.12 });
      geo = new THREE.SphereGeometry(0.35, 8, 6);
    } else {
      mat = new THREE.MeshStandardMaterial({ color: 0x7dd3fc, emissive: 0x38bdf8, roughness: 0.2, transparent: true, opacity: 0.95 });
      geo = new THREE.OctahedronGeometry(0.45, 0);
    }
    const mesh = new THREE.Mesh(geo, mat);
    mesh.position.set((Math.random() - 0.5) * 3.8, -depth * 0.2 + (Math.random() - 0.5) * 0.8, (Math.random() > 0.5 ? 2.2 : -2.2));
    mesh.castShadow = false;
    mesh.receiveShadow = false;
    shaftGroup.add(mesh);
    oreDecorations.push({ mesh, depth });
  }

  function populateOreDecorations() {
    oreDecorations.forEach((o) => shaftGroup.remove(o.mesh));
    oreDecorations = [];
    for (let i = 0; i < 35; i++) {
      createOreBlock("gold", 5 + Math.random() * 80);
    }
    for (let i = 0; i < 25; i++) {
      createOreBlock("oil", 30 + Math.random() * 140);
    }
    for (let i = 0; i < 18; i++) {
      createOreBlock("gem", 60 + Math.random() * 220);
    }
  }

  function initThree() {
    const canvas = document.getElementById("mine-canvas");
    canvas.height = 260;
    const w = canvas.clientWidth;
    const h = canvas.clientHeight;

    renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: false });
    renderer.setSize(w, h, false);
    renderer.setPixelRatio(window.devicePixelRatio || 1);
    renderer.outputEncoding = THREE.sRGBEncoding;
    renderer.toneMapping = THREE.ACESFilmicToneMapping;
    renderer.toneMappingExposure = 1.25;
    renderer.autoClear = false;

    scene = new THREE.Scene();
    scene.background = new THREE.Color(0x0f172a);
    scene.fog = new THREE.Fog(0x0b1220, 12, 90);

    camera = new THREE.PerspectiveCamera(45, w / h, 0.1, 300);
    camera.position.set(7, 7, 9);
    camera.lookAt(0, -5, 0);

    minimapCamera = new THREE.OrthographicCamera(-10, 10, 10, -10, 0.1, 80);
    minimapCamera.position.set(0, 20, 0);
    minimapCamera.lookAt(0, 0, 0);

    const hemi = new THREE.HemisphereLight(0xc3dafb, 0x3a2415, 1.5);
    scene.add(hemi);
    const dirLight = new THREE.DirectionalLight(0xfff7d6, 1.6);
    dirLight.position.set(8, 14, 8);
    scene.add(dirLight);
    const point = new THREE.PointLight(0xfacc15, 1.6, 22);
    point.position.set(-1, 1.2, 1);
    scene.add(point);

    const groundGeo = new THREE.PlaneGeometry(30, 30);
    const groundMat = new THREE.MeshStandardMaterial({
      color: 0x5b4631,
      roughness: 0.85,
      metalness: 0.08,
      map: createGroundTexture(),
    });
    const ground = new THREE.Mesh(groundGeo, groundMat);
    ground.rotation.x = -Math.PI / 2;
    ground.position.y = 0;
    scene.add(ground);

    shaftGroup = new THREE.Group();
    const wallMat = new THREE.MeshStandardMaterial({
      color: 0x3a2b22,
      roughness: 0.75,
      metalness: 0.12,
    });
    const wallMatDeep = new THREE.MeshStandardMaterial({
      color: 0x2c1f17,
      roughness: 0.8,
      metalness: 0.12,
    });
    const wallGeoX = new THREE.BoxGeometry(7, 130, 0.8);
    const wallGeoZ = new THREE.BoxGeometry(0.8, 130, 7);
    const wall1 = new THREE.Mesh(wallGeoX, wallMat);
    wall1.position.set(0, -65, -2.3);
    const wall2 = new THREE.Mesh(wallGeoX, wallMatDeep);
    wall2.position.set(0, -65, 2.3);
    const wall3 = new THREE.Mesh(wallGeoZ, wallMatDeep);
    wall3.position.set(-2.3, -65, 0);
    const wall4 = new THREE.Mesh(wallGeoZ, wallMat);
    wall4.position.set(2.3, -65, 0);
    shaftGroup.add(wall1, wall2, wall3, wall4);

    const rimGeo = new THREE.BoxGeometry(6.4, 0.4, 6.4);
    const rim = new THREE.Mesh(
      rimGeo,
      new THREE.MeshStandardMaterial({ color: 0x4a3324, roughness: 0.65, metalness: 0.08 })
    );
    rim.position.set(0, 0.2, 0);
    shaftGroup.add(rim);
    scene.add(shaftGroup);

    populateOreDecorations();

    const drillGroup = new THREE.Group();
    const bodyGeo = new THREE.CylinderGeometry(0.6, 0.6, 1.8, 16);
    const bodyMat = new THREE.MeshStandardMaterial({
      color: 0x94a3b8,
      metalness: 0.7,
      roughness: 0.3,
    });
    const body = new THREE.Mesh(bodyGeo, bodyMat);
    body.position.y = 1.4;
    drillGroup.add(body);

    const bitGeo = new THREE.ConeGeometry(0.5, 1.2, 16);
    const bitMat = new THREE.MeshStandardMaterial({
      color: 0xfacc15,
      metalness: 0.9,
      roughness: 0.2,
      emissive: 0x443c0f,
    });
    const bit = new THREE.Mesh(bitGeo, bitMat);
    bit.position.y = 0.4;
    bit.rotation.x = Math.PI;
    drillGroup.add(bit);

    drillGroup.position.set(0, 0.1, 0);
    scene.add(drillGroup);
    drillMesh = drillGroup;

    const markerGeo = new THREE.BoxGeometry(0.4, 0.4, 0.4);
    const markerMat = new THREE.MeshStandardMaterial({ color: 0x7dd3fc, emissive: 0x38bdf8, emissiveIntensity: 1.3 });
    minimapMarker = new THREE.Mesh(markerGeo, markerMat);
    minimapMarker.position.set(0, 0, 0);
    scene.add(minimapMarker);

    minerGroup = buildMiner();
    scene.add(minerGroup);

    window.addEventListener("resize", () => {
      const w2 = canvas.clientWidth;
      const h2 = canvas.clientHeight;
      camera.aspect = w2 / h2;
      camera.updateProjectionMatrix();
      renderer.setSize(w2, h2, false);
    });

    canvas.addEventListener("pointerdown", (e) => {
      isDragging = true;
      dragStart = { x: e.clientX, y: e.clientY };
    });
    window.addEventListener("pointermove", (e) => {
      if (!isDragging) return;
      const dx = e.clientX - dragStart.x;
      const dy = e.clientY - dragStart.y;
      dragStart = { x: e.clientX, y: e.clientY };
      targetYaw = THREE.MathUtils.clamp(targetYaw - dx * 0.003, -Math.PI * 0.8, Math.PI * 0.2);
      targetPitch = THREE.MathUtils.clamp(targetPitch - dy * 0.002, -0.6, 0.35);
    });
    window.addEventListener("pointerup", () => {
      isDragging = false;
    });
  }

  function spawnDust() {
    if (!drillMesh) return;
    const origin = drillMesh.position.clone();
    for (let i = 0; i < 8; i++) {
      const mesh = new THREE.Mesh(new THREE.SphereGeometry(0.08, 5, 5), dustMaterial);
      mesh.position.copy(origin);
      mesh.position.x += (Math.random() - 0.5) * 0.8;
      mesh.position.z += (Math.random() - 0.5) * 0.8;
      shaftGroup.add(mesh);
      dustParticles.push({
        mesh,
        vel: new THREE.Vector3((Math.random() - 0.5) * 1.4, 1 + Math.random() * 1.5, (Math.random() - 0.5) * 1.4),
        life: 0.9,
      });
    }
  }

  function updateDust(dt) {
    dustParticles = dustParticles.filter((p) => {
      p.life -= dt;
      p.mesh.position.addScaledVector(p.vel, dt);
      p.vel.y -= dt * 2.5;
      if (p.life <= 0) {
        shaftGroup.remove(p.mesh);
        return false;
      }
      return true;
    });
  }

  function updateOreVisibility() {
    const mine = getCurrentMine();
    const depth = mine ? mine.depth : 0;
    oreDecorations.forEach((o) => {
      o.mesh.visible = depth + 4 >= o.depth;
      if (o.mesh.visible) {
        o.mesh.material.emissiveIntensity = 0.6;
      }
    });
  }

  function projectToScreen(pos) {
    if (!camera || !renderer) return { x: 0, y: 0 };
    const rect = renderer.domElement.getBoundingClientRect();
    tempVec.copy(pos).project(camera);
    return {
      x: (tempVec.x * 0.5 + 0.5) * rect.width,
      y: (-tempVec.y * 0.5 + 0.5) * rect.height,
    };
  }

  function spawnFloatingTextFromGains(gains) {
    if (!floatingContainer) return;
    const pos = drillMesh ? drillMesh.getWorldPosition(new THREE.Vector3()) : new THREE.Vector3();
    const screen = projectToScreen(pos);
    const entries = [];
    if (gains.moneyGain > 0) entries.push({ text: `+${gains.moneyGain.toFixed(1)} ğŸ’°`, color: "#facc15" });
    if (gains.goldGain > 0.2) entries.push({ text: `+${gains.goldGain.toFixed(1)} ğŸª™`, color: "#fbbf24" });
    if (gains.oilGain > 0.2) entries.push({ text: `+${gains.oilGain.toFixed(1)} ğŸ›¢ï¸`, color: "#cbd5f5" });
    if (gains.gemGain > 0) entries.push({ text: `+${gains.gemGain.toFixed(2)} ğŸ’`, color: "#7dd3fc" });

    entries.forEach((entry, idx) => {
      const el = document.createElement("div");
      el.className = "floating-text";
      const clampedX = Math.min(floatingContainer.clientWidth - 12, Math.max(12, screen.x));
      const clampedY = Math.min(floatingContainer.clientHeight - 12, Math.max(12, screen.y - idx * 14 - 10));
      el.style.left = `${clampedX}px`;
      el.style.top = `${clampedY}px`;
      el.style.color = entry.color;
      el.textContent = entry.text;
      floatingContainer.appendChild(el);
      requestAnimationFrame(() => {
        el.style.opacity = 1;
        el.style.transform = `translate(-50%, -60%) translateY(-10px)`;
      });
      setTimeout(() => {
        el.style.opacity = 0;
        el.remove();
      }, 900);
    });
  }

  function animateMiner(dt) {
    if (!minerGroup) return;
    if (minerDigTimer > 0) {
      minerDigTimer -= dt;
      const swing = Math.sin(Math.max(minerDigTimer, 0) * Math.PI * 6) * 0.9;
      minerArmR.rotation.z = -swing;
      minerArmL.rotation.z = swing * 0.4;
      minerGroup.position.x = -2.5 + swing * 0.05;
    } else {
      autoDigTimer += dt * (1 + state.autoRate * 0.05);
      const swing = Math.sin(autoDigTimer * 2) * 0.2;
      minerArmR.rotation.z = swing;
      minerArmL.rotation.z = -swing * 0.5;
    }
  }

  function updateThree(dt) {
    if (!scene || !camera || !renderer) return;
    const mine = getCurrentMine();
    const depthVal = mine ? mine.depth : 0;
    updateOreVisibility();
    updateDust(dt);
    animateMiner(dt);

    const maxVisualDepth = 200;
    const depthRatio = Math.min(1, depthVal / maxVisualDepth);
    depthTargetY = -Math.min(depthVal * 0.16, 55);

    currentYaw = THREE.MathUtils.lerp(currentYaw, targetYaw, 0.08);
    currentPitch = THREE.MathUtils.lerp(currentPitch, targetPitch, 0.08);
    const radius = 10;
    const camX = Math.cos(currentYaw) * radius;
    const camZ = Math.sin(currentYaw) * radius;
    const camY = 7 + depthTargetY * 0.08 + Math.sin(currentPitch) * 2;
    camera.position.set(camX, camY, camZ);
    const lookTargetY = depthTargetY * 0.1;
    camera.lookAt(0, lookTargetY, 0);

    minimapCamera.position.y = THREE.MathUtils.lerp(minimapCamera.position.y, 18 + depthRatio * 3, 0.1);

    if (shaftGroup) {
      shaftGroup.position.y = THREE.MathUtils.lerp(shaftGroup.position.y || 0, depthTargetY, 0.15);
    }
    if (drillMesh) {
      drillMesh.position.y = THREE.MathUtils.lerp(drillMesh.position.y, depthTargetY + 0.4, 0.2);
      drillMesh.rotation.y += dt * 2 * (1 + state.autoRate * 0.15);
      if (digPulse > 0) {
        drillMesh.position.y += Math.sin((1 - digPulse) * Math.PI * 3) * 0.2;
      }
    }
    if (minerGroup) {
      minerGroup.position.y = drillMesh.position.y + 0.3;
    }

    if (minimapMarker && drillMesh) {
      minimapMarker.position.copy(drillMesh.position);
      minimapMarker.position.y += 0.5;
    }

    if (digPulse > 0) {
      digPulse -= dt * 2.5;
      if (digPulse < 0) digPulse = 0;
    }
    if (shakeTime > 0) {
      shakeTime -= dt;
      const s = (shakeTime / Math.max(shakeStrength, 0.0001)) * 0.2 * shakeStrength;
      camera.position.x += (Math.sin(performance.now() * 0.04) * s) / 2;
      camera.position.z += (Math.cos(performance.now() * 0.05) * s) / 2;
    }

    const pr = renderer.getPixelRatio();
    const viewW = renderer.domElement.clientWidth * pr;
    const viewH = renderer.domElement.clientHeight * pr;

    renderer.setViewport(0, 0, viewW, viewH);
    renderer.setScissor(0, 0, viewW, viewH);
    renderer.setScissorTest(true);
    renderer.clear();
    renderer.render(scene, camera);

    const miniW = viewW * 0.32;
    const miniH = viewH * 0.32;
    renderer.setViewport(viewW - miniW - 10 * pr, viewH - miniH - 10 * pr, miniW, miniH);
    renderer.setScissor(viewW - miniW - 10 * pr, viewH - miniH - 10 * pr, miniW, miniH);
    renderer.render(scene, minimapCamera);
  }

  // ===================== Supabase sync =====================
  async function ensureProfileExists() {
    if (!state.playerName) return;
    if (state.playerId) return;
    try {
      const { data, error } = await supabase
        .from("mg_players")
        .insert({
          name: state.playerName,
          best_depth: bestDepthAcrossMines(),
          total_gold: state.gold,
          room_code: state.roomCode || null,
          last_online: new Date().toISOString(),
        })
        .select()
        .single();

      if (error) {
        supabaseOnline = false;
        lastSyncError = error.message;
        updateOnlineStatusUI();
        return;
      }
      state.playerId = data.id;
      state.bestDepthSynced = data.best_depth || 0;
      supabaseOnline = true;
      lastSyncError = null;
      updateOnlineStatusUI();
      saveLocalState();
    } catch (e) {
      supabaseOnline = false;
      lastSyncError = e.message;
      updateOnlineStatusUI();
    }
  }

  async function syncProfile() {
    if (!sessionStarted) return;
    if (!state.playerName) return;

    await ensureProfileExists();
    if (!state.playerId) return;

    try {
      const { error } = await supabase
        .from("mg_players")
        .update({
          best_depth: bestDepthAcrossMines(),
          total_gold: state.gold,
          room_code: state.roomCode || null,
          last_online: new Date().toISOString(),
        })
        .eq("id", state.playerId);

      if (error) {
        supabaseOnline = false;
        lastSyncError = error.message;
      } else {
        supabaseOnline = true;
        lastSyncError = null;
        state.bestDepthSynced = bestDepthAcrossMines();
      }
      updateOnlineStatusUI();
      saveLocalState();
    } catch (e) {
      supabaseOnline = false;
      lastSyncError = e.message;
      updateOnlineStatusUI();
    }
  }

  async function loadLeaderboard() {
    if (!supabaseOnline && state.playerId == null) return;

    try {
      let query = supabase
        .from("mg_players")
        .select("*")
        .order("best_depth", { ascending: false })
        .limit(50);

      if (leaderboardMode === "room" && state.roomCode) {
        query = query.eq("room_code", state.roomCode);
      }

      const { data, error } = await query;

      if (error) {
        supabaseOnline = false;
        lastSyncError = error.message;
        updateOnlineStatusUI();
        return;
      }

      supabaseOnline = true;
      lastSyncError = null;
      updateOnlineStatusUI();

      renderLeaderboard(data || []);
      renderDepthRuler(data || []);
    } catch (e) {
      supabaseOnline = false;
      lastSyncError = e.message;
      updateOnlineStatusUI();
    }
  }

  function renderLeaderboard(players) {
    leaderboardListEl.innerHTML = "";
    if (!players.length) {
      const empty = document.createElement("div");
      empty.textContent = "HenÃ¼z kayÄ±tlÄ± oyuncu yok.";
      empty.style.color = "#9ca3af";
      empty.style.fontSize = "0.8rem";
      leaderboardListEl.appendChild(empty);
      return;
    }

    players.forEach((p, idx) => {
      const row = document.createElement("div");
      row.className = "lb-row";
      if (state.playerId && p.id === state.playerId) {
        row.classList.add("me");
      }

      const rank = document.createElement("div");
      rank.className = "lb-rank";
      rank.textContent = `${idx + 1}.`;

      const nameCell = document.createElement("div");
      nameCell.className = "lb-name";
      const nameSpan = document.createElement("span");
      nameSpan.textContent = p.name || "Anon";
      nameCell.appendChild(nameSpan);

      if (state.playerId && p.id === state.playerId) {
        const meChip = document.createElement("span");
        meChip.className = "me-chip";
        meChip.textContent = "Sen";
        nameCell.appendChild(meChip);
      }
      if (p.room_code) {
        const rc = document.createElement("span");
        rc.className = "room-code-pill";
        rc.textContent = p.room_code;
        nameCell.appendChild(rc);
      }

      const depthCell = document.createElement("div");
      depthCell.className = "lb-depth";
      depthCell.textContent = `${Number(p.best_depth || 0).toFixed(1)} m`;

      row.appendChild(rank);
      row.appendChild(nameCell);
      row.appendChild(depthCell);
      leaderboardListEl.appendChild(row);
    });
  }

  function renderDepthRuler(players) {
    const markers = depthRulerEl.querySelectorAll(".depth-marker");
    markers.forEach(m => m.remove());

    if (!players.length) return;

    let maxDepth = players.reduce(
      (max, p) => Math.max(max, Number(p.best_depth || 0)),
      0
    );
    if (maxDepth < 1) maxDepth = 1;

    players.slice(0, 20).forEach(p => {
      const depth = Number(p.best_depth || 0);
      const ratio = depth / maxDepth;
      const bottomPercent = 5 + ratio * 90;

      const marker = document.createElement("div");
      marker.className = "depth-marker";
      if (state.playerId && p.id === state.playerId) {
        marker.classList.add("me");
      }
      marker.style.bottom = `${bottomPercent}%`;

      const dot = document.createElement("div");
      dot.className = "dot";
      const label = document.createElement("div");
      label.className = "label";
      label.textContent = `${p.name || "Anon"} Â· ${depth.toFixed(0)} m`;

      marker.appendChild(dot);
      marker.appendChild(label);
      depthRulerEl.appendChild(marker);
    });
  }

  // ===================== Session / setup =====================
  function applyRoomLabel() {
    if (state.roomCode) {
      roomLabel.textContent = `Oda: ${state.roomCode}`;
    } else {
      roomLabel.textContent = "Global sÄ±ralama";
    }
  }

  function startSession() {
    if (!state.playerName) {
      setupErrorEl.textContent = "LÃ¼tfen ismini yaz.";
      return;
    }
    setupErrorEl.textContent = "";
    sessionStarted = true;
    recalcDerivedStats();
    updateStatsUI();
    applyRoomLabel();
    saveLocalState();

    setupSection.style.display = "none";
    gameSection.style.display = "block";

    log(`HoÅŸ geldin ${state.playerName}! Kazmaya baÅŸlayabilirsin.`);
    if (state.roomCode) {
      log(`Oda kodun: ${state.roomCode}. Bu kodu arkadaÅŸlarÄ±nla paylaÅŸ.`);
    }

    // Try to sync & load leaderboard
    syncProfile();
    loadLeaderboard();
  }

  // ===================== Events =====================
  btnStartSolo.addEventListener("click", () => {
    markInteraction();
    const name = playerNameInput.value.trim();
    if (!name) {
      setupErrorEl.textContent = "LÃ¼tfen ismini yaz.";
      return;
    }
    state.playerName = name;
    // global, no room code
    startSession();
  });

  btnJoinRoom.addEventListener("click", () => {
    markInteraction();
    const name = playerNameInput.value.trim();
    const code = roomCodeInput.value.trim().toUpperCase();
    if (!name) {
      setupErrorEl.textContent = "LÃ¼tfen ismini yaz.";
      return;
    }
    if (!code) {
      setupErrorEl.textContent = "Oda kodu boÅŸ olamaz.";
      return;
    }
    state.playerName = name;
    state.roomCode = code;
    createdRoomCodeEl.style.display = "none";
    startSession();
  });

  btnCreateRoom.addEventListener("click", () => {
    markInteraction();
    const name = playerNameInput.value.trim();
    if (!name) {
      setupErrorEl.textContent = "Ã–nce ismini yaz, sonra oda oluÅŸtur.";
      return;
    }
    state.playerName = name;
    const slug = Math.random().toString(36).substring(2, 7).toUpperCase();
    state.roomCode = slug;
    createdRoomCodeEl.style.display = "inline-block";
    createdRoomCodeEl.textContent = `Oda kodun: ${slug}`;
    setupErrorEl.textContent = "OdayÄ± kullanmak iÃ§in Ã¼stten 'Tek baÅŸÄ±ma / Global' deÄŸil, 'Odaya KatÄ±l' demene gerek yok; direkt BaÅŸlat diyebilirsin.";
  });

  btnDig.addEventListener("click", () => {
    if (!sessionStarted) return;
    markInteraction();
    if (isCollapseActive()) {
      log("GÃ¶Ã§Ã¼k sÄ±rasÄ±nda kazma Ã§ok zor, Ã¶nce onar!");
      return;
    }
    const gains = applyMining(state.perClick, false);
    minerDigTimer = 0.4;
    digPulse = 1;
    shakeStrength = Math.min(1.2, 0.1 + state.perClick * 0.04);
    shakeTime = 0.35;
    spawnDust();
    spawnFloatingTextFromGains(gains);
    soundManager.playDig();
    if (gains.moneyGain > 8) soundManager.playMoney();
    if (gains.gemGain > 0) soundManager.playGem();
    updateStatsUI();
    saveLocalState();
  });

  btnUpgradeAxe.addEventListener("click", () => {
    if (!sessionStarted) return;
    markInteraction();
    const mine = getCurrentMine();
    const cost = axeCost(mine.axeLevel);
    if (!spend(cost)) {
      log("Yeterli paran yok (Kazma yÃ¼kseltme).");
      return;
    }
    mine.axeLevel += 1;
    recalcDerivedStats();
    log(`${mine.name} kazma seviyesi ${mine.axeLevel} oldu.`);
    soundManager.playUpgrade();
    updateStatsUI();
    saveLocalState();
  });

  btnHireMiner.addEventListener("click", () => {
    if (!sessionStarted) return;
    markInteraction();
    const mine = getCurrentMine();
    const cost = minerCost(mine.miners);
    if (!spend(cost)) {
      log("Yeterli paran yok (Ä°ÅŸÃ§i kiralama).");
      return;
    }
    mine.miners += 1;
    recalcDerivedStats();
    log(`${mine.name} iÃ§in yeni iÅŸÃ§i iÅŸe alÄ±ndÄ±. Toplam: ${mine.miners}.`);
    soundManager.playUpgrade();
    updateStatsUI();
    saveLocalState();
  });

  btnUpgradeDrill.addEventListener("click", () => {
    if (!sessionStarted) return;
    markInteraction();
    const mine = getCurrentMine();
    const cost = drillCost(mine.drillLevel);
    if (!spend(cost)) {
      log("Yeterli paran yok (Matkap kulesi).");
      return;
    }
    mine.drillLevel += 1;
    recalcDerivedStats();
    log(`${mine.name} matkap seviyesi ${mine.drillLevel} oldu.`);
    soundManager.playUpgrade();
    updateStatsUI();
    saveLocalState();
  });

  btnUpgradeRadar.addEventListener("click", () => {
    if (!sessionStarted) return;
    markInteraction();
    const mine = getCurrentMine();
    const cost = radarCost(mine.radarLevel);
    if (!spend(cost)) {
      log("Yeterli paran yok (Jeo-Radar).");
      return;
    }
    mine.radarLevel += 1;
    recalcDerivedStats();
    log(`${mine.name} jeo-radar seviyesi ${mine.radarLevel} oldu.`);
    soundManager.playUpgrade();
    updateStatsUI();
    saveLocalState();
  });

  btnUpgradeEfficiency.addEventListener("click", () => {
    if (!sessionStarted) return;
    markInteraction();
    const mine = getCurrentMine();
    const cost = efficiencyCost(mine.efficiencyLevel);
    if (!spend(cost)) {
      log("Yeterli paran yok (Verimlilik).");
      return;
    }
    mine.efficiencyLevel += 1;
    recalcDerivedStats();
    log(`${mine.name} Ã§Ä±karma verimliliÄŸi ${mine.efficiencyLevel} oldu.`);
    soundManager.playUpgrade();
    updateStatsUI();
    saveLocalState();
  });

  function spendSpecial(cost) {
    if (state.gold < (cost.gold || 0) || state.gems < (cost.gems || 0)) return false;
    state.gold -= cost.gold || 0;
    state.gems -= cost.gems || 0;
    return true;
  }

  btnUpgradeElevator.addEventListener("click", () => {
    if (!sessionStarted || state.specialUpgrades.elevator) return;
    markInteraction();
    if (!spendSpecial({ gold: 300, gems: 20 })) {
      log("AsansÃ¶r iÃ§in yeterli altÄ±n/gems yok.");
      return;
    }
    state.specialUpgrades.elevator = true;
    recalcDerivedStats();
    log("Sonsuz AsansÃ¶r kuruldu! TÃ¼m oto kazma hÄ±zlandÄ±.");
    soundManager.playUpgrade();
    updateStatsUI();
    saveLocalState();
  });

  btnUpgradeStabilizer.addEventListener("click", () => {
    if (!sessionStarted || state.specialUpgrades.stabilizer >= 1) return;
    markInteraction();
    if (!spendSpecial({ gold: 250, gems: 10 })) {
      log("StabilizÃ¶r iÃ§in yeterli kaynak yok.");
      return;
    }
    state.specialUpgrades.stabilizer = 1;
    log("Patlama StabilizÃ¶rÃ¼ kuruldu. GÃ¶Ã§Ã¼k etkisi azaldÄ±.");
    soundManager.playUpgrade();
    saveLocalState();
    updateStatsUI();
  });

  btnUpgradeCrystalLab.addEventListener("click", () => {
    if (!sessionStarted || state.specialUpgrades.crystalLab) return;
    markInteraction();
    if (!spendSpecial({ gold: 500, gems: 35 })) {
      log("Kristal Bilgi Merkezi iÃ§in yeterli kaynak yok.");
      return;
    }
    state.specialUpgrades.crystalLab = true;
    log("Kristal Bilgi Merkezi aÃ§Ä±ldÄ±. Maden bulma oranÄ± arttÄ±!");
    soundManager.playUpgrade();
    saveLocalState();
    updateStatsUI();
  });

  btnUpgradeLuxury.addEventListener("click", () => {
    if (!sessionStarted) return;
    markInteraction();
    if (!spendSpecial({ gold: 100, gems: 5 })) {
      log("LÃ¼ks Ekipman iÃ§in kaynak yetersiz.");
      return;
    }
    state.specialUpgrades.luxury += 1;
    recalcDerivedStats();
    log(`LÃ¼ks Ekipman seviyesi ${state.specialUpgrades.luxury} oldu.`);
    soundManager.playUpgrade();
    saveLocalState();
    updateStatsUI();
  });

  btnToggleSfx.addEventListener("click", () => {
    markInteraction();
    soundManager.toggleMute();
    saveLocalState();
  });

  btnToggleMusic.addEventListener("click", () => {
    markInteraction();
    soundManager.toggleMusic();
    saveLocalState();
  });

  btnCharge.addEventListener("click", () => {
    if (!sessionStarted) return;
    markInteraction();
    if (nextChargeReadyInMs() > 0 && !isChargeActive()) return;
    const duration = 5000;
    const mine = getCurrentMine();
    const cooldown = Math.max(8000, 16000 - mine.drillLevel * 400 - mine.radarLevel * 200);
    state.chargeActiveUntil = Date.now() + duration;
    state.chargeReadyAt = Date.now() + cooldown;
    recalcDerivedStats();
    log("PatlayÄ±cÄ± yÃ¼k devrede! KazanÃ§lar katlandÄ±.");
    soundManager.playUpgrade();
    updateStatsUI();
    saveLocalState();
  });

  btnViewGlobal.addEventListener("click", () => {
    leaderboardMode = "global";
    btnViewGlobal.classList.add("active");
    btnViewRoom.classList.remove("active");
    loadLeaderboard();
  });

  btnViewRoom.addEventListener("click", () => {
    leaderboardMode = "room";
    btnViewRoom.classList.add("active");
    btnViewGlobal.classList.remove("active");
    loadLeaderboard();
  });

  btnRefreshLeaderboard.addEventListener("click", () => {
    loadLeaderboard();
  });

  btnRepair.addEventListener("click", () => {
    if (!isCollapseActive()) return;
    const cost = { money: 200, oil: 100 };
    if (state.money < cost.money || state.oil < cost.oil) {
      log("OnarÄ±m iÃ§in yeterli nakit/petrol yok.");
      return;
    }
    state.money -= cost.money;
    state.oil -= cost.oil;
    resolveCollapse(true);
  });

  // ===================== Game loop =====================
  function loop(now) {
    const dt = (now - lastFrameTime) / 1000;
    lastFrameTime = now;

    if (sessionStarted) {
      const chargeActive = isChargeActive();
      if (prevChargeActive && !chargeActive) {
        recalcDerivedStats();
      }
      prevChargeActive = chargeActive;
      maybeTriggerCollapse(dt);

      const collapseActive = isCollapseActive();
      if (state.autoRate > 0 && !collapseActive) {
        const gains = applyMining(state.autoRate * dt, true);
        minerDigTimer = Math.max(minerDigTimer, 0.18);
        autoSoundTimer -= dt;
        if (autoSoundTimer <= 0) {
          soundManager.playDig();
          autoSoundTimer = Math.max(0.6, 1.5 - state.autoRate * 0.05);
        }
        if (gains.gemGain > 0 && Math.random() < 0.15) soundManager.playGem();
      }
      if (state.currentEvent.type === "collapse" && Date.now() > state.currentEvent.endsAt) {
        resolveCollapse(false);
      }
      updateStatsUI();
    }

    updateThree(dt);
    requestAnimationFrame(loop);
  }

  // periodic save + sync
  setInterval(() => {
    if (!sessionStarted) return;
    saveLocalState();
    syncProfile();
    if (Math.random() < 0.4) {
      loadLeaderboard();
    }
  }, 15000);

  window.addEventListener("beforeunload", () => {
    saveLocalState();
  });

  // ===================== Init =====================
  window.addEventListener("pointerdown", () => markInteraction(), { once: true });

  loadLocalState();
  updateOnlineStatusUI();
  recalcDerivedStats();
  updateStatsUI();
  renderMineTabs();
  soundManager.updateMusicState();
  if (state.playerName) {
    playerNameInput.value = state.playerName;
  }
  if (state.roomCode) {
    roomCodeInput.value = state.roomCode;
  }

  initThree();
  requestAnimationFrame(loop);
</script>
</body>
</html>
